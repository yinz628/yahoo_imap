<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yahoo Mail Extractor</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; min-height: 100vh; }
    
    /* Login Page Styles */
    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }
    .login-card {
      background: white;
      border-radius: 12px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    /* Mobile: Smaller login card padding */
    @media (max-width: 768px) {
      .login-card {
        padding: 30px 20px;
      }
      .login-card h1 {
        font-size: 24px;
      }
    }
    .login-card h1 {
      color: #6001d2;
      text-align: center;
      margin-bottom: 10px;
      font-size: 28px;
    }
    .login-card .subtitle {
      color: #666;
      text-align: center;
      margin-bottom: 30px;
      font-size: 14px;
    }
    .login-card .form-group {
      margin-bottom: 20px;
    }
    .login-card label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
    }
    .login-card input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 15px;
      transition: border-color 0.2s;
    }
    .login-card input:focus {
      outline: none;
      border-color: #6001d2;
    }
    .login-card button {
      width: 100%;
      background: #6001d2;
      color: white;
      border: none;
      padding: 14px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    .login-card button:hover {
      background: #4a01a3;
    }
    .login-card button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .login-toggle {
      text-align: center;
      margin-top: 20px;
      color: #666;
      font-size: 14px;
    }
    .login-toggle a {
      color: #6001d2;
      text-decoration: none;
      font-weight: 500;
      cursor: pointer;
    }
    .login-toggle a:hover {
      text-decoration: underline;
    }
    .login-error {
      background: #f8d7da;
      color: #721c24;
      padding: 12px 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }
    .login-error.visible {
      display: block;
    }
    .login-success {
      background: #d4edda;
      color: #155724;
      padding: 12px 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }
    .login-success.visible {
      display: block;
    }

    /* Main App Styles */
    .app-container {
      display: none;
      padding: 20px;
    }
    .app-container.visible {
      display: block;
    }
    .container { max-width: 1200px; margin: 0 auto; width: 100%; }
    
    /* Responsive adjustments */
    @media (max-width: 1024px) {
      .container { max-width: 100%; }
    }
    h1 { color: #6001d2; margin-bottom: 20px; text-align: center; }
    .card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    
    /* Mobile: Reduce card padding */
    @media (max-width: 768px) {
      .card { padding: 15px; margin-bottom: 15px; }
    }
    .card h2 { color: #333; margin-bottom: 15px; font-size: 18px; border-bottom: 2px solid #6001d2; padding-bottom: 8px; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; color: #555; font-weight: 500; }
    input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #6001d2; }
    
    /* Settings checkbox style */
    .settings-checkbox { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; cursor: pointer; }
    .settings-checkbox input[type="checkbox"] { width: 18px; height: 18px; flex-shrink: 0; cursor: pointer; }
    .settings-checkbox span { font-size: 14px; color: #333; }
    
    .row { display: flex; gap: 15px; }
    .row .form-group { flex: 1; }
    
    /* Mobile: Stack rows vertically */
    @media (max-width: 768px) {
      .row { flex-direction: column; gap: 10px; }
    }
    button { background: #6001d2; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; }
    button:hover { background: #4a01a3; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    
    /* Mobile: Smaller buttons */
    @media (max-width: 768px) {
      button { padding: 10px 16px; font-size: 13px; }
    }
    .btn-secondary { background: #666; }
    .btn-secondary:hover { background: #555; }
    .btn-danger { background: #dc3545; }
    .btn-danger:hover { background: #c82333; }
    .status { padding: 10px; border-radius: 4px; margin-bottom: 15px; }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.info { background: #cce5ff; color: #004085; }
    .hidden { display: none; }
    #results { max-height: 400px; overflow-y: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 8px; text-align: left; border-bottom: 1px solid #eee; }
    th { background: #f8f9fa; font-weight: 600; position: sticky; top: 0; }
    tr:hover { background: #f8f9fa; }
    
    /* Mobile: Smaller table text and padding */
    @media (max-width: 768px) {
      table { font-size: 11px; }
      th, td { padding: 6px 4px; }
      
      /* Hide less important columns on mobile */
      .email-sender {
        display: none;
      }
      th:nth-child(3),
      td:nth-child(3) {
        display: none;
      }
    }
    .match { background: #fff3cd; padding: 2px 4px; border-radius: 2px; }
    .progress { height: 20px; background: #e9ecef; border-radius: 4px; overflow: hidden; margin: 10px 0; }
    .progress-bar { height: 100%; background: #6001d2; transition: width 0.3s; }
    .checkbox-group { display: flex; align-items: center; gap: 8px; }
    .checkbox-group input { width: auto; }

    /* Navigation Sidebar */
    .app-layout {
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      width: 200px;
      background: white;
      border-right: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      z-index: 100;
      box-shadow: 2px 0 8px rgba(0,0,0,0.05);
      transition: transform 0.3s ease;
    }
    
    /* Mobile: Hide sidebar by default, show with toggle */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }
      .sidebar.mobile-open {
        transform: translateX(0);
      }
    }
    .sidebar-header {
      padding: 20px 15px;
      border-bottom: 1px solid #e0e0e0;
      text-align: center;
      position: relative;
    }
    .sidebar-header h1 {
      font-size: 18px;
      color: #6001d2;
      margin: 0;
    }
    
    /* Mobile close button in sidebar */
    .sidebar-close-btn {
      display: none;
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      font-size: 24px;
      color: #666;
      cursor: pointer;
      padding: 5px;
      line-height: 1;
    }
    
    @media (max-width: 768px) {
      .sidebar-close-btn {
        display: block;
      }
    }
    .sidebar-nav {
      flex: 1;
      padding: 15px 0;
    }
    .nav-item {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      color: #555;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid transparent;
      font-size: 14px;
    }
    .nav-item:hover {
      background: #f5f5f5;
      color: #6001d2;
    }
    .nav-item.active {
      background: #f0e6ff;
      color: #6001d2;
      border-left-color: #6001d2;
      font-weight: 500;
    }
    .nav-item .nav-icon {
      margin-right: 10px;
      font-size: 16px;
    }
    .sidebar-footer {
      padding: 15px;
      border-top: 1px solid #e0e0e0;
      background: #fafafa;
    }
    .sidebar-user {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      font-size: 13px;
      color: #333;
    }
    .sidebar-user .user-icon {
      margin-right: 8px;
      font-size: 16px;
    }
    .sidebar-user .username {
      color: #6001d2;
      font-weight: 500;
    }
    .sidebar-logout {
      width: 100%;
      background: #dc3545;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s;
    }
    .sidebar-logout:hover {
      background: #c82333;
    }
    
    /* Main Content Area */
    .main-content {
      flex: 1;
      margin-left: 200px;
      padding: 20px;
      min-height: 100vh;
      max-width: 100%;
      overflow-x: hidden;
    }
    
    /* Mobile: No left margin, add menu button */
    @media (max-width: 768px) {
      .main-content {
        margin-left: 0;
        padding: 10px;
      }
    }
    
    /* Feature Modules */
    .feature-module {
      display: none;
    }
    .feature-module.active {
      display: block;
    }
    
    /* Legacy User Header - hidden when sidebar is used */
    .user-header {
      display: none;
    }
    
    /* Mailbox List Styles */
    .mailbox-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 15px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      margin-bottom: 10px;
      transition: all 0.2s;
    }
    .mailbox-item:hover {
      border-color: #6001d2;
      box-shadow: 0 2px 8px rgba(96, 1, 210, 0.1);
    }
    .mailbox-item .mailbox-info {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
      cursor: pointer;
    }
    .mailbox-item .mailbox-icon {
      font-size: 20px;
    }
    .mailbox-item .mailbox-email {
      font-weight: 500;
      color: #333;
    }
    .mailbox-item .mailbox-date {
      font-size: 12px;
      color: #999;
    }
    .mailbox-item .mailbox-actions {
      display: flex;
      gap: 8px;
    }
    .mailbox-item .btn-use {
      background: #6001d2;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .mailbox-item .btn-use:hover {
      background: #4a01a3;
    }
    .mailbox-item .btn-delete {
      background: #dc3545;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .mailbox-item .btn-delete:hover {
      background: #c82333;
    }
    .mailbox-empty {
      text-align: center;
      padding: 30px;
      color: #999;
      background: #f9f9f9;
      border-radius: 6px;
      border: 1px dashed #ddd;
    }
    
    /* Pattern History Styles */
    .pattern-item {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      padding: 12px 15px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      margin-bottom: 10px;
      transition: all 0.2s;
    }
    .pattern-item:hover {
      border-color: #6001d2;
      box-shadow: 0 2px 8px rgba(96, 1, 210, 0.1);
    }
    .pattern-item .pattern-info {
      flex: 1;
      cursor: pointer;
      min-width: 0;
    }
    .pattern-item .pattern-subject {
      font-weight: 500;
      color: #333;
      margin-bottom: 4px;
      word-break: break-word;
    }
    .pattern-item .pattern-regex {
      font-family: monospace;
      font-size: 12px;
      color: #666;
      background: #f5f5f5;
      padding: 4px 8px;
      border-radius: 3px;
      word-break: break-all;
      display: block;
      margin-bottom: 4px;
    }
    .pattern-item .pattern-date {
      font-size: 11px;
      color: #999;
    }
    .pattern-item .pattern-actions {
      display: flex;
      gap: 8px;
      margin-left: 10px;
      flex-shrink: 0;
    }
    .pattern-item .btn-apply {
      background: #6001d2;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .pattern-item .btn-apply:hover {
      background: #4a01a3;
    }
    .pattern-item .btn-delete-pattern {
      background: #dc3545;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .pattern-item .btn-delete-pattern:hover {
      background: #c82333;
    }
    
    /* Rule History Styles */
    .rule-item {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      padding: 12px 15px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      margin-bottom: 10px;
      transition: all 0.2s;
    }
    .rule-item:hover {
      border-color: #6001d2;
      box-shadow: 0 2px 8px rgba(96, 1, 210, 0.1);
    }
    .rule-item .rule-info {
      flex: 1;
      cursor: pointer;
      min-width: 0;
    }
    .rule-item .rule-name {
      font-weight: 600;
      color: #6001d2;
      margin-bottom: 4px;
      font-size: 14px;
    }
    .rule-item .rule-subject {
      font-size: 13px;
      color: #333;
      margin-bottom: 4px;
      word-break: break-word;
    }
    .rule-item .rule-regex {
      font-family: monospace;
      font-size: 11px;
      color: #666;
      background: #f5f5f5;
      padding: 4px 8px;
      border-radius: 3px;
      word-break: break-all;
      display: block;
      margin-bottom: 4px;
    }
    .rule-item .rule-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 4px;
    }
    .rule-item .rule-tag {
      display: inline-block;
      background: #e3f2fd;
      color: #1565c0;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      cursor: pointer;
    }
    .rule-item .rule-tag:hover {
      background: #bbdefb;
    }
    .rule-item .rule-meta {
      font-size: 11px;
      color: #999;
    }
    .rule-item .rule-actions {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-left: 10px;
      flex-shrink: 0;
    }
    .rule-item .btn-use-rule {
      background: #6001d2;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      white-space: nowrap;
    }
    .rule-item .btn-use-rule:hover {
      background: #4a01a3;
    }
    .rule-item .btn-edit-rule {
      background: #17a2b8;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      white-space: nowrap;
    }
    .rule-item .btn-edit-rule:hover {
      background: #138496;
    }
    .rule-item .btn-delete-rule {
      background: #dc3545;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      white-space: nowrap;
    }
    .rule-item .btn-delete-rule:hover {
      background: #c82333;
    }
    .rule-empty {
      text-align: center;
      padding: 30px;
      color: #999;
      background: #f9f9f9;
      border-radius: 6px;
      border: 1px dashed #ddd;
    }
    .pattern-empty {
      text-align: center;
      padding: 20px;
      color: #999;
      background: #f9f9f9;
      border-radius: 6px;
      border: 1px dashed #ddd;
      font-size: 13px;
    }
    
    /* Pattern Tags Styles */
    .pattern-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
    }
    .pattern-tag {
      display: inline-block;
      background: #e3f2fd;
      color: #1565c0;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      cursor: pointer;
    }
    .pattern-tag:hover {
      background: #bbdefb;
    }
    
    /* Email Management Styles */
    .folder-item {
      padding: 10px 12px;
      cursor: pointer;
      border-radius: 4px;
      margin-bottom: 4px;
      font-size: 13px;
      color: #555;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .folder-item:hover {
      background: #f0f0f0;
      color: #6001d2;
    }
    .folder-item.active {
      background: #f0e6ff;
      color: #6001d2;
      font-weight: 500;
    }
    .folder-item .folder-icon {
      font-size: 14px;
    }
    .folder-item .folder-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .email-row {
      cursor: pointer;
      transition: background 0.2s;
    }
    .email-row:hover {
      background: #f5f5f5;
    }
    .email-row.selected {
      background: #f0e6ff;
    }
    .email-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .email-subject {
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .email-sender {
      max-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .email-date {
      font-size: 12px;
      color: #666;
      white-space: nowrap;
    }
    .pagination-btn {
      padding: 6px 12px;
      font-size: 13px;
    }
    .pagination-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Email Content Modal */
    .email-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .email-modal-overlay.visible {
      display: flex;
    }
    .email-modal {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    .email-modal-header {
      padding: 20px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    .email-modal-header h3 {
      margin: 0;
      color: #333;
      font-size: 18px;
      word-break: break-word;
      flex: 1;
      padding-right: 15px;
    }
    .email-modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
      padding: 0;
      line-height: 1;
    }
    .email-modal-close:hover {
      color: #333;
    }
    .email-modal-meta {
      padding: 15px 20px;
      background: #f9f9f9;
      border-bottom: 1px solid #e0e0e0;
      font-size: 13px;
      color: #666;
    }
    .email-modal-meta p {
      margin: 5px 0;
    }
    .email-modal-meta strong {
      color: #333;
    }
    .email-modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
      font-size: 14px;
      line-height: 1.6;
    }
    .email-modal-body pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: inherit;
      margin: 0;
    }
    .email-modal-loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    /* Code Pattern Builder Modal */
    .pattern-builder-modal {
      background: white;
      border-radius: 12px;
      width: 95%;
      max-width: 700px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    .pattern-builder-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }
    .pattern-part {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }
    .pattern-part-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .pattern-part-header label {
      font-weight: 600;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .pattern-part-header .part-badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      background: #6001d2;
      color: white;
    }
    .pattern-part-toggle {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .pattern-part-toggle input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .pattern-part-content {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .pattern-part-content input,
    .pattern-part-content select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .pattern-part-content input:focus,
    .pattern-part-content select:focus {
      outline: none;
      border-color: #6001d2;
    }
    .pattern-part-hint {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    .pattern-preview-box {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 14px;
      word-break: break-all;
      margin-top: 15px;
    }
    .pattern-preview-box .regex-prefix { color: #9cdcfe; }
    .pattern-preview-box .regex-fixed { color: #ce9178; }
    .pattern-preview-box .regex-variable { color: #4ec9b0; }
    .pattern-preview-box .regex-separator { color: #d7ba7d; }
    .pattern-preview-box .regex-group { color: #dcdcaa; }
    .pattern-builder-actions {
      padding: 15px 20px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    .pattern-builder-actions button {
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }
    .quick-prefix-btns {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 8px;
    }
    /* Code segment styles */
    .code-segment {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 10px;
    }
    .code-segment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .code-segment-header .segment-label {
      font-weight: 600;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .code-segment-header .segment-value {
      font-family: 'Consolas', 'Monaco', monospace;
      background: #f0f0f0;
      padding: 2px 8px;
      border-radius: 4px;
      color: #6001d2;
    }
    .code-segment-body {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .segment-type-select {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
      min-width: 120px;
    }
    .segment-type-select:focus {
      outline: none;
      border-color: #6001d2;
    }
    .segment-length-info {
      font-size: 12px;
      color: #666;
      background: #f8f9fa;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .segment-fixed-badge {
      background: #ce9178;
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
    }
    .segment-variable-badge {
      background: #4ec9b0;
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
    }
    .segment-separator {
      text-align: center;
      color: #d7ba7d;
      font-weight: bold;
      font-size: 18px;
      padding: 5px 0;
    }

    .quick-prefix-btn {
      padding: 4px 10px;
      font-size: 12px;
      background: #e9ecef;
      border: 1px solid #ced4da;
      border-radius: 4px;
      cursor: pointer;
    }
    .quick-prefix-btn:hover {
      background: #dee2e6;
    }
    .quick-prefix-btn.active {
      background: #6001d2;
      color: white;
      border-color: #6001d2;
    }
    .separator-options {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .separator-option {
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
    }
    .separator-option input[type="radio"] {
      cursor: pointer;
    }
    .analyzed-parts {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 15px;
    }
    .analyzed-parts-title {
      font-weight: 600;
      color: #856404;
      margin-bottom: 8px;
    }
    .analyzed-parts-content {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .analyzed-part-tag {
      background: white;
      border: 1px solid #ffc107;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 13px;
    }
    .analyzed-part-tag.prefix { border-color: #9cdcfe; background: #e8f4fd; }
    .analyzed-part-tag.fixed { border-color: #ce9178; background: #fdf2e8; }
    .analyzed-part-tag.variable { border-color: #4ec9b0; background: #e8fdf8; }
    .analyzed-part-tag.separator { border-color: #d7ba7d; background: #fdfbe8; }
    
    /* Email Preview Search Styles */
    /* Requirements: 2.3, 2.4 */
    .preview-search-box {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px;
      background: #f0f0f0;
      border-radius: 4px 4px 0 0;
      border: 1px solid #ddd;
      border-bottom: none;
    }
    .preview-search-box input {
      flex: 1;
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 13px;
      min-width: 150px;
    }
    .preview-search-box input:focus {
      outline: none;
      border-color: #6001d2;
    }
    .preview-search-box .search-nav-btn {
      background: #6001d2;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      min-width: 32px;
    }
    .preview-search-box .search-nav-btn:hover {
      background: #4a01a3;
    }
    .preview-search-box .search-nav-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .preview-search-box .search-count {
      font-size: 12px;
      color: #666;
      white-space: nowrap;
      min-width: 60px;
      text-align: center;
    }
    .preview-search-box .search-clear-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .preview-search-box .search-clear-btn:hover {
      background: #c82333;
    }
    .search-highlight {
      background: #fff3cd;
      padding: 1px 2px;
      border-radius: 2px;
      border: 1px solid #ffc107;
    }
    .search-highlight.current {
      background: #ffc107;
      border-color: #e0a800;
      box-shadow: 0 0 4px rgba(255, 193, 7, 0.5);
    }
    .preview-content-wrapper {
      margin-top: 0;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 0 0 4px 4px;
      max-height: 450px;
      overflow: auto;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 12px;
      border: 1px solid #ddd;
      border-top: none;
    }
    .preview-content-wrapper.no-search {
      border-radius: 4px;
      border-top: 1px solid #ddd;
    }
    .preview-generate-rule-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-left: 8px;
    }
    .preview-generate-rule-btn:hover {
      background: #218838;
    }
    .preview-generate-rule-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    /* Rule Editor Panel Styles - Requirements: 3.4, 4.1, 4.6 */
    #ruleEditorCard {
      transition: box-shadow 0.2s;
    }
    #ruleEditorCard:focus-within {
      box-shadow: 0 4px 12px rgba(96, 1, 210, 0.2);
    }
    #ruleEditorCard h2 {
      color: #6001d2;
      border-bottom-color: #6001d2;
    }
    #ruleEditorCard .form-group label {
      font-size: 13px;
    }
    #ruleEditorCard input:focus,
    #ruleEditorCard select:focus {
      border-color: #6001d2;
      box-shadow: 0 0 0 2px rgba(96, 1, 210, 0.1);
    }
    .rule-validation-success {
      background: #d4edda;
      color: #155724;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #c3e6cb;
    }
    .rule-validation-error {
      background: #f8d7da;
      color: #721c24;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #f5c6cb;
    }
    .rule-validation-warning {
      background: #fff3cd;
      color: #856404;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #ffeaa7;
    }
    .rule-match-highlight {
      background: #fff3cd;
      padding: 2px 4px;
      border-radius: 2px;
      border: 1px solid #ffc107;
      font-weight: 500;
    }
    .pattern-suggestion-item {
      padding: 10px;
      margin: 8px 0;
      background: white;
      border-radius: 4px;
      border-left: 3px solid #6001d2;
      cursor: pointer;
      transition: all 0.2s;
    }
    .pattern-suggestion-item:hover {
      background: #f8f9fa;
      border-left-color: #28a745;
    }
    .pattern-suggestion-item .pattern-name {
      font-weight: 600;
      color: #6001d2;
      margin-bottom: 4px;
    }
    .pattern-suggestion-item .pattern-code {
      font-family: monospace;
      font-size: 12px;
      color: #666;
      background: #f5f5f5;
      padding: 4px 8px;
      border-radius: 3px;
      display: block;
      margin-bottom: 4px;
    }
    .pattern-suggestion-item .pattern-desc {
      font-size: 12px;
      color: #999;
    }
    
    /* Mobile Menu Button */
    .mobile-menu-btn {
      display: none;
      position: fixed;
      top: 15px;
      left: 15px;
      z-index: 101;
      background: #6001d2;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 18px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    @media (max-width: 768px) {
      .mobile-menu-btn {
        display: block;
      }
    }
    
    /* Mobile Overlay */
    .mobile-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 99;
    }
    
    @media (max-width: 768px) {
      .mobile-overlay.visible {
        display: block;
      }
    }
    
    /* Responsive Email Modal */
    @media (max-width: 768px) {
      .email-modal {
        width: 95%;
        max-height: 95vh;
      }
      .email-modal-header h3 {
        font-size: 16px;
      }
      .email-modal-body {
        font-size: 13px;
      }
    }
    
    /* Responsive Preview Search Box */
    @media (max-width: 768px) {
      .preview-search-box {
        flex-wrap: wrap;
        gap: 6px;
      }
      .preview-search-box input {
        min-width: 100px;
        flex: 1 1 100%;
      }
      .preview-search-box .search-count {
        min-width: 50px;
      }
    }
    
    /* Responsive Email Management Layout */
    @media (max-width: 1024px) {
      #module-email-management > div > div {
        flex-direction: column !important;
      }
      #module-email-management .card[style*="width:200px"] {
        width: 100% !important;
      }
    }
    
    /* Responsive button groups */
    @media (max-width: 768px) {
      div[style*="display:flex"][style*="gap"] {
        flex-wrap: wrap;
      }
      .mailbox-item {
        flex-direction: column;
        align-items: flex-start;
      }
      .mailbox-item .mailbox-actions {
        width: 100%;
        margin-top: 10px;
      }
      .pattern-item,
      .rule-item {
        flex-direction: column;
        align-items: flex-start;
      }
      .pattern-item .pattern-actions,
      .rule-item .rule-actions {
        width: 100%;
        margin-left: 0;
        margin-top: 10px;
        flex-direction: row;
      }
    }
    
    /* Responsive form groups */
    @media (max-width: 768px) {
      .form-group label {
        font-size: 13px;
      }
      input, select, textarea {
        font-size: 14px;
        padding: 8px;
      }
    }
    
    /* Responsive headings */
    @media (max-width: 768px) {
      h1 {
        font-size: 24px;
        margin-bottom: 15px;
      }
      .card h2 {
        font-size: 16px;
      }
    }
    
    /* Ensure content doesn't overflow */
    * {
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    
    /* Responsive pagination */
    @media (max-width: 768px) {
      #emailPagination {
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
      }
      #emailPagination > div {
        justify-content: center;
      }
    }
    
    /* Responsive status messages */
    @media (max-width: 768px) {
      .status {
        font-size: 13px;
        padding: 8px;
      }
    }
    
    /* Smooth scrolling */
    html {
      scroll-behavior: smooth;
    }
  </style>
</head>
<body>
  <!-- Login Page -->
  <div class="login-container" id="loginPage">
    <div class="login-card">
      <h1>📧 Yahoo Mail Extractor</h1>
      <p class="subtitle" id="loginSubtitle">请登录以访问系统</p>
      
      <div class="login-error" id="loginError"></div>
      <div class="login-success" id="loginSuccess"></div>
      
      <form id="loginForm" onsubmit="handleAuthSubmit(event)">
        <div class="form-group">
          <label for="authUsername">用户名</label>
          <input type="text" id="authUsername" placeholder="请输入用户名" required minlength="3" maxlength="20">
        </div>
        <div class="form-group">
          <label for="authPassword">密码</label>
          <input type="password" id="authPassword" placeholder="请输入密码" required minlength="6">
        </div>
        <button type="submit" id="authSubmitBtn">登录</button>
      </form>
    </div>
  </div>

  <!-- Main App (hidden until authenticated) -->
  <div class="app-container" id="mainApp">
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleMobileMenu()">☰</button>
    
    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileMenu()"></div>
    
    <div class="app-layout">
      <!-- Navigation Sidebar -->
      <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <h1>📧 Yahoo Mail Extractor</h1>
          <button class="sidebar-close-btn" onclick="closeMobileMenu()">&times;</button>
        </div>
        <div class="sidebar-nav">
          <div class="nav-item active" data-module="mailbox-management" onclick="switchModule('mailbox-management')">
            <span class="nav-icon">📬</span>
            <span>邮箱管理</span>
          </div>
          <div class="nav-item" data-module="extraction" onclick="switchModule('extraction')">
            <span class="nav-icon">🎫</span>
            <span>提取折扣码</span>
          </div>
          <div class="nav-item" data-module="email-management" onclick="switchModule('email-management')">
            <span class="nav-icon">📧</span>
            <span>邮件管理</span>
          </div>
          <div class="nav-item" data-module="settings" onclick="switchModule('settings')">
            <span class="nav-icon">⚙️</span>
            <span>数据管理</span>
          </div>
        </div>
        <div class="sidebar-footer">
          <div class="sidebar-user">
            <span class="user-icon">👤</span>
            <span>当前用户: <span class="username" id="sidebarUsername"></span></span>
          </div>
          <button class="sidebar-logout" onclick="handleLogout()">退出登录</button>
        </div>
      </nav>

      <!-- Main Content Area -->
      <main class="main-content">
        <!-- Debug Info (shown in all modules) -->
        <div class="card" style="background:#f0f0f0; margin-bottom:20px;">
          <h2 style="font-size:14px; color:#666;">🔧 调试信息</h2>
          <p style="font-size:12px; color:#666; margin:0;">
            API 地址: <code id="apiUrl"></code><br>
            服务器状态: <span id="serverStatus">检查中...</span>
          </p>
        </div>
        <script>document.getElementById('apiUrl').textContent = window.location.origin;</script>

        <!-- Module 1: Mailbox Management -->
        <div class="feature-module active" id="module-mailbox-management">
          <h1 style="color:#6001d2; margin-bottom:20px;">📬 邮箱管理</h1>
          
          <!-- Saved Mailboxes Card -->
          <div class="card" id="savedMailboxesCard">
            <h2>已保存的邮箱</h2>
            <div id="mailboxListStatus"></div>
            <div id="mailboxList" style="margin-bottom:15px;">
              <p style="color:#666;">加载中...</p>
            </div>
            
            <!-- Add Mailbox Form -->
            <div style="background:#f9f9f9; padding:15px; border-radius:4px; margin-top:15px; border:1px solid #e0e0e0;">
              <h3 style="color:#333; margin-bottom:10px; font-size:16px;" id="mailboxFormTitle">➕ 添加新邮箱</h3>
              <div class="row">
                <div class="form-group">
                  <label>邮箱类型</label>
                  <select id="newMailboxProvider" onchange="updateMailboxPlaceholder()">
                    <option value="yahoo">Yahoo Mail</option>
                    <option value="gmail">Gmail</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>邮箱地址</label>
                  <input type="email" id="newMailboxEmail" placeholder="your@yahoo.com">
                </div>
              </div>
              <div class="form-group">
                <label>App Password (应用专用密码)</label>
                <input type="password" id="newMailboxPassword" placeholder="xxxx xxxx xxxx xxxx">
                <small style="color:#666;" id="passwordHint">Yahoo: 在账户安全设置中生成应用专用密码</small>
              </div>
              <div style="display:flex; gap:10px;">
                <button onclick="saveMailboxForm()" id="saveMailboxBtn">添加邮箱</button>
                <button onclick="cancelMailboxEdit()" id="cancelMailboxBtn" class="btn-secondary" style="display:none;">取消</button>
              </div>
              <input type="hidden" id="editingMailboxId" value="">
            </div>
          </div>
          
          <!-- Connection Card -->
          <div class="card" id="connectionCard">
            <h2>连接邮箱</h2>
            <div id="connectionStatus"></div>
            <div id="connectionForm">
              <div class="row">
                <div class="form-group">
                  <label>Yahoo 邮箱地址</label>
                  <input type="email" id="email" placeholder="your@yahoo.com">
                </div>
                <div class="form-group">
                  <label>App Password (应用专用密码)</label>
                  <input type="password" id="password" placeholder="xxxx xxxx xxxx xxxx">
                </div>
              </div>
              <button onclick="connect()">连接</button>
              <button class="btn-secondary" onclick="loadSettings()" style="margin-left:10px">加载保存的配置</button>
            </div>
            <div id="connectedInfo" class="hidden">
              <p>✅ 已连接: <strong id="connectedEmail"></strong></p>
              <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-secondary" onclick="saveSettings()">💾 保存配置</button>
                <button class="btn-danger" onclick="disconnect()">🔌 断开连接</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Module 2: Extraction (提取折扣码) -->
        <div class="feature-module" id="module-extraction">
          <h1 style="color:#6001d2; margin-bottom:20px;">🎫 提取折扣码</h1>
          
          <!-- Filter Card -->
          <div class="card" id="filterCard">
            <h2>筛选条件</h2>
            <div class="row">
              <div class="form-group">
                <label>文件夹</label>
                <select id="folder"></select>
              </div>
              <div class="form-group">
                <label>发件人 (可选)</label>
                <input type="text" id="sender" placeholder="sender@example.com">
              </div>
            </div>
            <div class="row">
              <div class="form-group">
                <label>开始日期</label>
                <input type="date" id="dateFrom">
              </div>
              <div class="form-group">
                <label>结束日期</label>
                <input type="date" id="dateTo">
              </div>
            </div>
            <div class="form-group">
              <label>主题包含 (可选)</label>
              <input type="text" id="subject" placeholder="关键词">
            </div>
            <button onclick="countEmails()">统计邮件数量</button>
            <button class="btn-secondary" onclick="previewEmail()" style="margin-left:10px">预览第一封邮件</button>
            <div id="countResult" class="hidden status info"></div>
            
            <!-- Email Preview with Search - Requirements: 2.3, 2.4, 2.5 -->
            <div id="previewContainer" class="hidden" style="margin-top:15px;">
              <!-- Search Box - Requirements: 2.3, 2.4 -->
              <div class="preview-search-box" id="previewSearchBox">
                <input type="text" id="previewSearchInput" placeholder="在邮件中搜索..." onkeydown="handlePreviewSearchKeydown(event)">
                <button class="search-nav-btn" onclick="searchInPreview()" title="搜索">🔍</button>
                <span class="search-count" id="previewSearchCount">0/0</span>
                <button class="search-nav-btn" onclick="navigatePreviewSearch('prev')" title="上一个" id="previewSearchPrev" disabled>▲</button>
                <button class="search-nav-btn" onclick="navigatePreviewSearch('next')" title="下一个" id="previewSearchNext" disabled>▼</button>
                <button class="search-clear-btn" onclick="clearPreviewSearch()" title="清除搜索">✕</button>
                <button class="preview-generate-rule-btn" onclick="generateRuleFromSelection()" id="generateRuleBtn" disabled title="选择文本后可生成规则">📋 生成规则</button>
              </div>
              <!-- Preview Content -->
              <div id="previewResult" class="preview-content-wrapper"></div>
            </div>
          </div>

          <!-- Pattern Card -->
          <div class="card" id="patternCard">
            <h2>提取模式</h2>
            
            <!-- Rule History Section - Collapsible Panel -->
            <!-- Requirements: 1.1, 1.2, 1.3 -->
            <div class="card" id="ruleHistoryCard" style="margin-bottom:20px;">
              <div style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;" onclick="toggleRuleHistoryPanel()">
                <h2 style="margin:0; display:flex; align-items:center; gap:8px;">
                  <span id="ruleHistoryToggleIcon">▼</span>
                  📜 规则历史
                  <span id="ruleHistoryCount" style="font-size:12px; color:#666; font-weight:normal;"></span>
                </h2>
                <button class="btn-secondary" style="padding:4px 12px; font-size:12px;" onclick="event.stopPropagation(); loadRuleHistory();">🔄 刷新</button>
              </div>
              
              <div id="ruleHistoryContent" style="margin-top:15px;">
                <div id="ruleHistoryStatus"></div>
                
                <!-- Tag Filter -->
                <div id="ruleTagFilter" style="margin-bottom:10px; display:none;">
                  <label style="font-size:13px; color:#666; margin-right:8px;">按标签筛选:</label>
                  <select id="ruleTagSelect" onchange="filterRulesByTag()" style="padding:4px 8px; font-size:13px;">
                    <option value="">全部</option>
                  </select>
                </div>
                
                <div id="ruleHistoryList" style="max-height:400px; overflow-y:auto;">
                  <p style="color:#666;">加载中...</p>
                </div>
              </div>
            </div>
            
            <!-- Rule Editor Panel - Requirements: 3.4, 4.1, 4.6 -->
            <div class="card" id="ruleEditorCard" style="margin-bottom:20px; border:2px solid #6001d2;">
              <h2 style="display:flex; align-items:center; gap:8px;">
                <span>📝</span> 规则编辑器
                <span id="ruleEditorStatus" style="font-size:12px; color:#666; font-weight:normal; margin-left:auto;"></span>
              </h2>
              
              <!-- Target String Section - Requirements: 3.4 -->
              <div style="background:#f9f9f9; padding:15px; border-radius:4px; margin-bottom:15px; border:1px solid #e0e0e0;">
                <h3 style="color:#333; margin-bottom:10px; font-size:14px;">🎯 目标字符串</h3>
                <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
                  <div class="form-group" style="flex:1; margin-bottom:0; min-width:200px;">
                    <label>从预览邮件中复制目标文本</label>
                    <input type="text" id="targetString" placeholder="例如: BDAY-ABC123 或 code: 50OFF">
                  </div>
                  <button onclick="openPatternBuilder()" style="background:#6001d2; white-space:nowrap;">🔧 智能生成</button>
                  <button onclick="generateRuleFromTarget()" style="background:#28a745; white-space:nowrap;">🤖 快速生成</button>
                </div>
                
                <!-- Generated Pattern Suggestions -->
                <div id="generatedPatterns" class="hidden" style="margin-top:15px;">
                  <label style="font-weight:600; color:#6001d2; font-size:13px;">生成的规则建议：</label>
                  <div id="patternsList" style="margin-top:10px;"></div>
                </div>
              </div>
              
              <!-- Editable Rule Fields - Requirements: 4.1 -->
              <div style="background:#fff9f0; padding:15px; border-radius:4px; margin-bottom:15px; border:1px solid #ffe0b2;">
                <h3 style="color:#333; margin-bottom:10px; font-size:14px;">✏️ 规则字段</h3>
                
                <div class="form-group">
                  <label>模式名称 <span style="color:#dc3545;">*</span></label>
                  <input type="text" id="patternName" value="default" placeholder="为规则起一个名称">
                </div>
                
                <div class="form-group">
                  <label>主题模式 (用于筛选邮件)</label>
                  <input type="text" id="ruleSubjectPattern" placeholder="例如: Your.*discount.*code 或 优惠码">
                </div>
                
                <div class="row">
                  <div class="form-group" style="flex:2;">
                    <label>正则表达式 <span style="color:#dc3545;">*</span></label>
                    <input type="text" id="pattern" placeholder="例如: (?<code>\d{6}) 或 [A-Z0-9]{8,12}">
                  </div>
                  <div class="form-group" style="flex:1;">
                    <label>标志</label>
                    <select id="patternFlags">
                      <option value="g">g (全局匹配)</option>
                      <option value="gi">gi (全局+忽略大小写)</option>
                      <option value="i">i (忽略大小写)</option>
                      <option value="gm">gm (全局+多行)</option>
                      <option value="gim">gim (全局+忽略大小写+多行)</option>
                    </select>
                  </div>
                </div>
                
                <div class="form-group">
                  <label>标签 (用逗号分隔)</label>
                  <input type="text" id="patternTags" placeholder="例如: 折扣码, 优惠券, 电商">
                </div>
              </div>
              
              <!-- Validation Section - Requirements: 4.3, 4.4, 4.5 -->
              <div style="background:#f0f8f0; padding:15px; border-radius:4px; margin-bottom:15px; border:1px solid #b2dfb2;">
                <h3 style="color:#333; margin-bottom:10px; font-size:14px;">✅ 规则验证</h3>
                <p style="color:#666; font-size:12px; margin-bottom:10px;">验证正则表达式语法并测试匹配效果</p>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <button onclick="validateRuleSyntax()" class="btn-secondary" style="font-size:13px;">🔍 验证语法</button>
                  <button onclick="testRuleInPreview()" class="btn-secondary" style="font-size:13px;">🧪 测试匹配</button>
                  <button onclick="validateRegex()" class="btn-secondary" style="font-size:13px;">📧 验证邮件</button>
                </div>
                <div id="ruleValidationResult" class="hidden" style="margin-top:15px; padding:10px; background:white; border-radius:4px; border:1px solid #b2dfb2;"></div>
                <div id="validationResult" class="hidden" style="margin-top:15px; padding:10px; background:white; border-radius:4px; border:1px solid #b2dfb2;"></div>
              </div>
              
              <!-- Action Buttons - Requirements: 4.6 -->
              <div style="display:flex; gap:10px; flex-wrap:wrap; padding-top:10px; border-top:1px solid #e0e0e0;">
                <button onclick="saveRuleToHistory()" style="background:#6001d2;">💾 保存规则</button>
                <button onclick="useCurrentRule()" class="btn-secondary">▶️ 使用规则</button>
                <button onclick="clearRuleEditor()" class="btn-secondary" style="background:#dc3545;">🗑️ 清空</button>
              </div>
            </div>
          </div>

            <!-- Extraction Options -->
            <div class="card" id="extractionOptionsCard">
              <h2>⚙️ 提取选项</h2>
              
              <!-- Current Rule Display -->
              <div id="currentRuleDisplay" class="hidden" style="margin-bottom:15px; padding:12px; background:#f0e6ff; border-radius:6px; border:1px solid #d4c4e8;">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                  <div style="flex:1;">
                    <div style="font-weight:600; color:#6001d2; margin-bottom:4px;">
                      📋 <span id="currentRuleName">未命名规则</span>
                    </div>
                    <div style="font-size:13px; color:#333; margin-bottom:4px;">
                      主题: <span id="currentRuleSubject">(无主题筛选)</span>
                    </div>
                    <code style="font-size:11px; color:#666; background:#fff; padding:4px 8px; border-radius:3px; display:block; word-break:break-all;" id="currentRuleRegex"></code>
                    <div style="font-size:11px; color:#888; margin-top:4px;">
                      标志: <span id="currentRuleFlags">g</span>
                      <span id="currentRuleTags" style="margin-left:10px;"></span>
                    </div>
                  </div>
                  <button onclick="clearCurrentRule()" style="background:#dc3545; padding:4px 8px; font-size:11px; margin-left:10px;">✕ 清除</button>
                </div>
              </div>
              
              <div class="checkbox-group">
                <input type="checkbox" id="stripHtml">
                <label for="stripHtml">提取前去除 HTML 标签</label>
              </div>
              <div class="form-group" style="margin-top:15px;">
                <label>提取速度 (每封邮件延迟 ms)</label>
                <div style="display:flex; gap:10px; align-items:center;">
                  <input type="range" id="delayMs" min="0" max="1000" value="100" style="flex:1;">
                  <span id="delayValue" style="min-width:50px; text-align:right;">100ms</span>
                </div>
                <small style="color:#666;">值越大，提取越慢，CPU 占用越低。建议 100-500ms</small>
              </div>
              <br>
              <button id="extractBtn" onclick="extract()" disabled style="opacity:0.5; cursor:not-allowed;">🚀 开始提取</button>
              <small id="extractBtnHint" style="color:#999; margin-left:10px;">请先选择或创建一个规则</small>
            </div>

          <!-- Results Card -->
          <div class="card hidden" id="resultsCard">
            <h2>提取结果</h2>
            <div id="extractStatus"></div>
            <div style="margin-bottom:15px;">
              <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span id="progressText">准备中...</span>
                <span id="progressPercent">0%</span>
              </div>
              <div class="progress">
                <div class="progress-bar" id="progressBar" style="width:0%"></div>
              </div>
            </div>
            <div id="liveMatches" style="margin-bottom:15px; padding:10px; background:#f0f8ff; border-radius:4px; max-height:300px; overflow-y:auto; border:1px solid #b0d4ff;">
              <strong>实时提取结果：</strong>
              <div id="matchesList" style="margin-top:10px; font-size:13px;"></div>
            </div>
            <div id="results"></div>
            <br>
            <button onclick="exportCSV()">导出 CSV</button>
          </div>
        </div>

        <!-- Module 3: Email Management -->
        <div class="feature-module" id="module-email-management">
          <h1 style="color:#6001d2; margin-bottom:20px;">📧 邮件管理</h1>
          
          <!-- Connection Required Notice -->
          <div class="card" id="emailMgmtConnectionNotice">
            <div style="text-align:center; padding:30px;">
              <p style="font-size:48px; margin-bottom:15px;">🔌</p>
              <h3 style="color:#333; margin-bottom:10px;">请先连接邮箱</h3>
              <p style="color:#666; margin-bottom:20px;">在使用邮件管理功能前，请先在"邮箱管理"中连接您的邮箱账户。</p>
              <button onclick="switchModule('mailbox-management')">前往邮箱管理</button>
            </div>
          </div>
          
          <!-- Email Management Main Content (hidden until connected) -->
          <div id="emailMgmtContent" style="display:none;">
            <!-- Email Management Layout -->
            <div style="display:flex; gap:20px;">
              <!-- Folder Sidebar -->
              <div class="card" style="width:200px; flex-shrink:0;">
                <h2 style="font-size:16px;">📁 文件夹</h2>
                <div id="emailFolderList" style="margin-top:10px;">
                  <p style="color:#666; font-size:13px;">加载中...</p>
                </div>
              </div>
              
              <!-- Email List Area -->
              <div class="card" style="flex:1; min-width:0;">
                <h2 style="font-size:16px;">📬 邮件列表</h2>
                
                <!-- Search Bar -->
                <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap;">
                  <div style="flex:1; min-width:200px;">
                    <input type="text" id="emailSearchPattern" placeholder="搜索主题关键词..." style="width:100%;">
                  </div>
                  <button onclick="searchEmails()">🔍 搜索</button>
                  <button class="btn-secondary" onclick="clearEmailSearch()">清除</button>
                </div>
                
                <!-- Action Buttons -->
                <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap; align-items:center;">
                  <div style="display:flex; align-items:center; gap:5px;">
                    <input type="checkbox" id="selectAllEmails" onchange="toggleSelectAllEmails()">
                    <label for="selectAllEmails" style="margin:0; font-size:13px; cursor:pointer;">全选</label>
                  </div>
                  <button class="btn-danger" onclick="batchDeleteSelectedEmails()" id="btnBatchDelete" disabled>🗑️ 删除选中 (<span id="selectedCount">0</span>)</button>
                  <button class="btn-secondary" onclick="refreshEmailList()">🔄 刷新</button>
                  <div style="display:flex; align-items:center; gap:5px; margin-left:10px;">
                    <label style="margin:0; font-size:13px;">排序:</label>
                    <select id="emailSortOrder" onchange="changeEmailSortOrder()" style="padding:4px 8px; font-size:13px;">
                      <option value="desc">日期 ↓ (最新)</option>
                      <option value="asc">日期 ↑ (最早)</option>
                    </select>
                  </div>
                  <span id="emailListStatus" style="font-size:13px; color:#666;"></span>
                </div>
                
                <!-- Email Table -->
                <div style="overflow-x:auto;">
                  <table id="emailTable" style="width:100%; min-width:600px;">
                    <thead>
                      <tr>
                        <th style="width:40px;"></th>
                        <th style="width:120px;">日期</th>
                        <th style="width:180px;">发件人</th>
                        <th>主题</th>
                      </tr>
                    </thead>
                    <tbody id="emailTableBody">
                      <tr>
                        <td colspan="4" style="text-align:center; padding:30px; color:#666;">
                          选择一个文件夹以查看邮件
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                
                <!-- Pagination Controls -->
                <div id="emailPagination" style="display:flex; justify-content:space-between; align-items:center; margin-top:15px; padding-top:15px; border-top:1px solid #eee;">
                  <div style="font-size:13px; color:#666;">
                    <span id="paginationInfo">-</span>
                  </div>
                  <div style="display:flex; gap:5px; align-items:center;">
                    <button class="btn-secondary" id="btnPrevPage" onclick="goToEmailPage('prev')" disabled style="padding:8px 12px;">◀ 上一页</button>
                    <span id="pageIndicator" style="padding:0 10px; font-size:13px;">第 1 页</span>
                    <button class="btn-secondary" id="btnNextPage" onclick="goToEmailPage('next')" disabled style="padding:8px 12px;">下一页 ▶</button>
                    <select id="pageSizeSelect" onchange="changePageSize()" style="margin-left:10px; padding:6px;">
                      <option value="10">10 条/页</option>
                      <option value="20" selected>20 条/页</option>
                      <option value="50">50 条/页</option>
                      <option value="100">100 条/页</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Legacy Email Management Card -->
            <div class="card" id="managementCard" style="margin-top:20px;">
              <h2>⚠️ 高级操作</h2>
              <div style="background:#fff3e0; padding:15px; border-radius:4px; margin-bottom:15px; border:1px solid #ffcc80;">
                <p style="color:#e65100; margin:0; font-size:13px;">⚠️ 警告：删除操作不可撤销！请谨慎操作。</p>
              </div>
              
              <div class="row">
                <div class="form-group">
                  <label>回收站管理</label>
                  <p style="color:#666; font-size:12px; margin:5px 0;">查看或清空回收站中的邮件</p>
                  <div style="display:flex; gap:10px;">
                    <button class="btn-secondary" onclick="getTrashCount()">查看回收站</button>
                    <button class="btn-danger" onclick="emptyTrash()">🗑️ 清空回收站</button>
                  </div>
                </div>
              </div>
              <div id="managementResult" class="hidden status info"></div>
            </div>
          </div>
        </div>

        <!-- Module 4: Settings / Data Management -->
        <div class="feature-module" id="module-settings">
          <h1 style="color:#6001d2; margin-bottom:20px;">⚙️ 数据管理</h1>
          
          <!-- Export Data Card -->
          <div class="card">
            <h2>📤 导出数据</h2>
            <p style="color:#666; font-size:13px; margin-bottom:15px;">导出您的邮箱配置和提取规则，可用于备份或迁移到其他设备。</p>
            <button onclick="exportUserData()" style="background:#28a745; color:white; padding:10px 20px; border:none; border-radius:4px; cursor:pointer;">
              📥 下载数据备份
            </button>
          </div>
          
          <!-- Import Data Card -->
          <div class="card" style="margin-top:20px;">
            <h2>📥 导入数据</h2>
            <p style="color:#666; font-size:13px; margin-bottom:15px;">从备份文件恢复您的邮箱配置和提取规则。</p>
            
            <div class="settings-checkbox">
              <input type="checkbox" id="importMergeMode" checked>
              <span>合并模式（跳过已存在的数据）</span>
            </div>
            
            <div class="settings-checkbox">
              <input type="checkbox" id="importMailboxes" checked>
              <span>导入邮箱配置</span>
            </div>
            
            <div class="settings-checkbox">
              <input type="checkbox" id="importPatterns" checked>
              <span>导入提取规则</span>
            </div>
            
            <input type="file" id="importFileInput" accept=".json" style="display:none;" onchange="handleImportFile(event)">
            <button onclick="document.getElementById('importFileInput').click()" style="background:#007bff; color:white; padding:10px 20px; border:none; border-radius:4px; cursor:pointer;">
              📂 选择备份文件
            </button>
            <div id="importResult" style="margin-top:15px;"></div>
          </div>
          
          <!-- Clear Data Card -->
          <div class="card" style="margin-top:20px;">
            <h2>🗑️ 清除数据</h2>
            <div style="background:#fff3e0; padding:15px; border-radius:4px; margin-bottom:15px; border:1px solid #ffcc80;">
              <p style="color:#e65100; margin:0; font-size:13px;">⚠️ 警告：此操作不可撤销！建议先导出备份。</p>
            </div>
            
            <div class="settings-checkbox">
              <input type="checkbox" id="clearMailboxes">
              <span>清除所有邮箱配置</span>
            </div>
            
            <div class="settings-checkbox">
              <input type="checkbox" id="clearPatterns">
              <span>清除所有提取规则</span>
            </div>
            
            <button onclick="clearUserData()" class="btn-danger" style="padding:10px 20px;">
              🗑️ 清除选中的数据
            </button>
            <div id="clearResult" style="margin-top:15px;"></div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Email Content Modal -->
  <div class="email-modal-overlay" id="emailModal" onclick="closeEmailModal(event)">
    <div class="email-modal" onclick="event.stopPropagation()">
      <div class="email-modal-header">
        <h3 id="emailModalSubject">邮件主题</h3>
        <button class="email-modal-close" onclick="closeEmailModal()">&times;</button>
      </div>
      <div class="email-modal-meta">
        <p><strong>发件人:</strong> <span id="emailModalFrom"></span></p>
        <p><strong>收件人:</strong> <span id="emailModalTo"></span></p>
        <p><strong>日期:</strong> <span id="emailModalDate"></span></p>
      </div>
      <div class="email-modal-body" id="emailModalBody">
        <div class="email-modal-loading">加载中...</div>
      </div>
    </div>
  </div>

  <!-- Pattern Builder Modal -->
  <div class="email-modal-overlay" id="patternBuilderModal" onclick="closePatternBuilder(event)">
    <div class="pattern-builder-modal" onclick="event.stopPropagation()">
      <div class="email-modal-header">
        <h3>🔧 智能规则生成器</h3>
        <button class="email-modal-close" onclick="closePatternBuilder()">&times;</button>
      </div>
      <div class="pattern-builder-body">
        <!-- Analyzed parts display -->
        <div class="analyzed-parts" id="analyzedParts">
          <div class="analyzed-parts-title">📊 自动分析结果</div>
          <div class="analyzed-parts-content" id="analyzedPartsContent"></div>
        </div>

        <!-- Part 1: Prefix keywords -->
        <div class="pattern-part">
          <div class="pattern-part-header">
            <label><span class="part-badge">1</span> 提示词前缀</label>
            <div class="pattern-part-toggle">
              <input type="checkbox" id="enablePrefix" checked onchange="updatePatternPreview()">
              <span>启用</span>
            </div>
          </div>
          <div class="pattern-part-content">
            <input type="text" id="prefixKeywords" placeholder="code|代码|优惠码|折扣码" onchange="updatePatternPreview()" oninput="updatePatternPreview()">
            <div class="quick-prefix-btns">
              <button class="quick-prefix-btn" onclick="addPrefixKeyword('code')">code</button>
              <button class="quick-prefix-btn" onclick="addPrefixKeyword('代码')">代码</button>
              <button class="quick-prefix-btn" onclick="addPrefixKeyword('优惠码')">优惠码</button>
              <button class="quick-prefix-btn" onclick="addPrefixKeyword('折扣码')">折扣码</button>
              <button class="quick-prefix-btn" onclick="addPrefixKeyword('兑换码')">兑换码</button>
              <button class="quick-prefix-btn" onclick="addPrefixKeyword('promo')">promo</button>
              <button class="quick-prefix-btn" onclick="addPrefixKeyword('coupon')">coupon</button>
              <button class="quick-prefix-btn" onclick="addPrefixKeyword('use')">use</button>
            </div>
            <div class="pattern-part-hint">多个关键词用 | 分隔，匹配时不区分大小写</div>
          </div>
        </div>

        <!-- Part 2: Code segments (dynamically generated) -->
        <div class="pattern-part">
          <div class="pattern-part-header">
            <label><span class="part-badge">2</span> 码的组成部分</label>
          </div>
          <div class="pattern-part-content">
            <div class="pattern-part-hint" style="margin-bottom:10px;">
              检测到的分隔符: <strong id="detectedSeparator">-</strong>，
              码由 <strong id="segmentCount">1</strong> 部分组成
            </div>
            <div id="codeSegmentsContainer">
              <!-- Segments will be dynamically generated here -->
            </div>
          </div>
        </div>

        <!-- Pattern Preview -->
        <div>
          <label style="font-weight:600; color:#333; margin-bottom:8px; display:block;">📝 生成的正则表达式</label>
          <div class="pattern-preview-box" id="patternPreviewBox">
            <span class="regex-group">(?&lt;code&gt;</span><span class="regex-variable">[A-Z0-9]{4,12}</span><span class="regex-group">)</span>
          </div>
        </div>
      </div>
      <div class="pattern-builder-actions">
        <button onclick="closePatternBuilder()" class="btn-secondary">取消</button>
        <button onclick="applyBuiltPattern()" style="background:#28a745; color:white;">✓ 应用规则</button>
      </div>
    </div>
  </div>

  <script>
    const API = '';
    let sessionId = null;
    let extractedResults = [];
    let authToken = null;
    let currentUser = null;

    // ==================== API Client with Auth Token ====================
    
    /**
     * Centralized API client that automatically includes auth token
     * and handles 401 responses by redirecting to login.
     * Requirements: 7.1, 7.2, 7.3
     */
    async function apiRequest(endpoint, options = {}) {
      const headers = {
        'Content-Type': 'application/json',
        ...(options.headers || {})
      };
      
      // Add Authorization header if we have a token
      if (authToken) {
        headers['Authorization'] = `Bearer ${authToken}`;
      }
      
      const fetchOptions = {
        ...options,
        headers
      };
      
      try {
        const response = await fetch(`${API}${endpoint}`, fetchOptions);
        
        // Handle 401 Unauthorized - redirect to login
        if (response.status === 401) {
          console.log('[API] Received 401, redirecting to login');
          // Clear session data
          authToken = null;
          currentUser = null;
          sessionStorage.removeItem('authToken');
          sessionStorage.removeItem('currentUser');
          // Redirect to login page
          showLoginPage();
          throw new Error('Session expired, please login again');
        }
        
        return response;
      } catch (error) {
        // Re-throw the error for the caller to handle
        throw error;
      }
    }
    
    /**
     * Convenience method for GET requests with auth
     */
    async function apiGet(endpoint) {
      return apiRequest(endpoint, { method: 'GET' });
    }
    
    /**
     * Convenience method for POST requests with auth
     */
    async function apiPost(endpoint, body) {
      return apiRequest(endpoint, {
        method: 'POST',
        body: JSON.stringify(body)
      });
    }
    
    /**
     * Convenience method for DELETE requests with auth
     */
    async function apiDelete(endpoint, body = null) {
      const options = { method: 'DELETE' };
      if (body) {
        options.body = JSON.stringify(body);
      }
      return apiRequest(endpoint, options);
    }
    
    /**
     * Convenience method for PUT requests with auth
     */
    async function apiPut(endpoint, body) {
      return apiRequest(endpoint, {
        method: 'PUT',
        body: JSON.stringify(body)
      });
    }

    // ==================== Authentication Functions ====================
    
    // Show login error message
    function showLoginError(message) {
      const errorEl = document.getElementById('loginError');
      errorEl.textContent = message;
      errorEl.classList.add('visible');
    }

    // Hide login error message
    function hideLoginError() {
      const errorEl = document.getElementById('loginError');
      errorEl.classList.remove('visible');
    }

    // Show login success message
    function showLoginSuccess(message) {
      const successEl = document.getElementById('loginSuccess');
      successEl.textContent = message;
      successEl.classList.add('visible');
    }

    // Hide login success message
    function hideLoginSuccess() {
      const successEl = document.getElementById('loginSuccess');
      successEl.classList.remove('visible');
    }

    // Handle login form submission
    async function handleAuthSubmit(event) {
      event.preventDefault();
      
      const username = document.getElementById('authUsername').value.trim();
      const password = document.getElementById('authPassword').value;
      
      if (!username || !password) {
        showLoginError('请输入用户名和密码');
        return;
      }

      const submitBtn = document.getElementById('authSubmitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = '登录中...';
      
      hideLoginError();
      hideLoginSuccess();

      try {
        // Use direct fetch for auth endpoints (no token needed yet)
        const res = await fetch(`${API}/api/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await res.json();

        if (!res.ok) {
          showLoginError(data.error || '登录失败');
          return;
        }

        // Login successful
        authToken = data.token;
        currentUser = data.user;
        sessionStorage.setItem('authToken', authToken);
        sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
        showMainApp();
      } catch (e) {
        showLoginError('网络错误: ' + e.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = '登录';
      }
    }

    // ==================== User Data Export/Import Functions ====================
    
    // Export user data
    async function exportUserData() {
      try {
        const res = await apiGet('/api/user/export');
        if (!res.ok) {
          throw new Error('导出失败');
        }
        
        const data = await res.json();
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `user-data-${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert(`导出成功！\n邮箱: ${data.mailboxes?.length || 0} 个\n规则: ${data.patterns?.length || 0} 个`);
      } catch (e) {
        alert('导出失败: ' + e.message);
      }
    }
    
    // Handle import file selection
    async function handleImportFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const resultEl = document.getElementById('importResult');
      
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        
        if (!data.mailboxes && !data.patterns) {
          throw new Error('无效的备份文件格式');
        }
        
        const mergeMode = document.getElementById('importMergeMode').checked;
        const importMailboxes = document.getElementById('importMailboxes').checked;
        const importPatterns = document.getElementById('importPatterns').checked;
        
        if (!importMailboxes && !importPatterns) {
          resultEl.innerHTML = '<p style="color:#dc3545;">请至少选择一项要导入的数据</p>';
          return;
        }
        
        const res = await apiPost('/api/user/import', {
          data,
          options: { merge: mergeMode, importMailboxes, importPatterns }
        });
        
        const result = await res.json();
        
        if (result.success) {
          resultEl.innerHTML = `
            <p style="color:#28a745;">✅ 导入成功！</p>
            <p style="font-size:13px; color:#666;">
              邮箱: 导入 ${result.imported.mailboxes} 个，跳过 ${result.skipped.mailboxes} 个<br>
              规则: 导入 ${result.imported.patterns} 个，跳过 ${result.skipped.patterns} 个
            </p>
          `;
          // Refresh mailbox list if on that module
          if (document.getElementById('module-mailbox-management').classList.contains('active')) {
            loadMailboxes();
          }
        } else {
          resultEl.innerHTML = `<p style="color:#dc3545;">❌ 导入失败: ${result.error}</p>`;
        }
      } catch (e) {
        resultEl.innerHTML = `<p style="color:#dc3545;">❌ 导入失败: ${e.message}</p>`;
      }
      
      // Reset file input
      event.target.value = '';
    }
    
    // Clear user data
    async function clearUserData() {
      const clearMailboxes = document.getElementById('clearMailboxes').checked;
      const clearPatterns = document.getElementById('clearPatterns').checked;
      
      if (!clearMailboxes && !clearPatterns) {
        alert('请至少选择一项要清除的数据');
        return;
      }
      
      const items = [];
      if (clearMailboxes) items.push('邮箱配置');
      if (clearPatterns) items.push('提取规则');
      
      if (!confirm(`确定要清除以下数据吗？\n\n${items.join('\n')}\n\n此操作不可撤销！`)) {
        return;
      }
      
      const resultEl = document.getElementById('clearResult');
      
      try {
        const res = await apiDelete('/api/user/data', { clearMailboxes, clearPatterns });
        const result = await res.json();
        
        if (result.success) {
          resultEl.innerHTML = `
            <p style="color:#28a745;">✅ 清除成功！</p>
            <p style="font-size:13px; color:#666;">
              邮箱: 清除 ${result.cleared.mailboxes} 个<br>
              规则: 清除 ${result.cleared.patterns} 个
            </p>
          `;
          // Uncheck boxes
          document.getElementById('clearMailboxes').checked = false;
          document.getElementById('clearPatterns').checked = false;
          // Refresh mailbox list
          loadMailboxes();
        } else {
          resultEl.innerHTML = `<p style="color:#dc3545;">❌ 清除失败: ${result.error}</p>`;
        }
      } catch (e) {
        resultEl.innerHTML = `<p style="color:#dc3545;">❌ 清除失败: ${e.message}</p>`;
      }
    }

    // Handle logout
    async function handleLogout() {
      if (!confirm('确定要退出登录吗？')) {
        return;
      }

      try {
        if (authToken) {
          await apiPost('/api/auth/logout', {});
        }
      } catch (e) {
        console.error('Logout error:', e);
      }

      // Clear session
      authToken = null;
      currentUser = null;
      sessionStorage.removeItem('authToken');
      sessionStorage.removeItem('currentUser');
      
      // Disconnect from mailbox if connected
      if (sessionId) {
        try {
          await apiPost('/api/disconnect', { sessionId });
        } catch (e) {
          console.error('Disconnect error:', e);
        }
        sessionId = null;
      }

      // Show login page
      showLoginPage();
    }

    // Show login page
    function showLoginPage() {
      document.getElementById('loginPage').style.display = 'flex';
      document.getElementById('mainApp').classList.remove('visible');
      
      // Reset form
      document.getElementById('authUsername').value = '';
      document.getElementById('authPassword').value = '';
      hideLoginError();
      hideLoginSuccess();
    }

    // Show main app
    function showMainApp() {
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('mainApp').classList.add('visible');
      
      // Update username in sidebar
      const username = currentUser?.username || 'Unknown';
      document.getElementById('sidebarUsername').textContent = username;
      
      // Check server status
      checkServerStatus();
      
      // Load saved mailboxes
      loadMailboxes();
      
      // Set default module to mailbox management
      switchModule('mailbox-management');
    }

    // ==================== Mailbox Management Functions ====================
    
    // Provider display names
    const providerNames = {
      'yahoo': 'Yahoo',
      'gmail': 'Gmail',
      'custom': '自定义'
    };
    
    // Provider icons
    const providerIcons = {
      'yahoo': '📧',
      'gmail': '📬',
      'custom': '✉️'
    };
    
    // Update placeholder based on selected provider
    function updateMailboxPlaceholder() {
      const provider = document.getElementById('newMailboxProvider').value;
      const emailInput = document.getElementById('newMailboxEmail');
      const passwordHint = document.getElementById('passwordHint');
      
      if (provider === 'gmail') {
        emailInput.placeholder = 'your@gmail.com';
        passwordHint.textContent = 'Gmail: 在Google账户安全设置中生成应用专用密码';
      } else {
        emailInput.placeholder = 'your@yahoo.com';
        passwordHint.textContent = 'Yahoo: 在账户安全设置中生成应用专用密码';
      }
    }
    
    // Load and display saved mailboxes
    async function loadMailboxes() {
      const mailboxList = document.getElementById('mailboxList');
      const statusEl = document.getElementById('mailboxListStatus');
      
      try {
        const res = await apiGet('/api/mailboxes');

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.error || 'Failed to load mailboxes');
        }

        const data = await res.json();
        const mailboxes = data.mailboxes || [];

        if (mailboxes.length === 0) {
          mailboxList.innerHTML = `
            <div class="mailbox-empty">
              <p>📭 还没有保存的邮箱</p>
              <p style="font-size:13px; margin-top:5px;">添加邮箱后可以快速连接</p>
            </div>
          `;
        } else {
          mailboxList.innerHTML = mailboxes.map(mailbox => {
            const provider = mailbox.provider || 'yahoo';
            const icon = providerIcons[provider] || '📧';
            const providerName = providerNames[provider] || 'Yahoo';
            return `
            <div class="mailbox-item" data-id="${escapeHtml(mailbox.id)}">
              <div class="mailbox-info" onclick="useMailbox('${escapeHtml(mailbox.id)}')">
                <span class="mailbox-icon">${icon}</span>
                <div>
                  <div class="mailbox-email">${escapeHtml(mailbox.email)}</div>
                  <div class="mailbox-date">
                    <span style="background:#e3f2fd; color:#1565c0; padding:1px 6px; border-radius:10px; font-size:10px; margin-right:5px;">${providerName}</span>
                    添加于 ${new Date(mailbox.addedAt).toLocaleDateString()}
                  </div>
                </div>
              </div>
              <div class="mailbox-actions">
                <button class="btn-use" onclick="useMailbox('${escapeHtml(mailbox.id)}')">使用</button>
                <button class="btn-edit-rule" onclick="editMailbox('${escapeHtml(mailbox.id)}')" style="background:#17a2b8;">编辑</button>
                <button class="btn-delete" onclick="deleteMailbox('${escapeHtml(mailbox.id)}', '${escapeHtml(mailbox.email)}')">删除</button>
              </div>
            </div>
          `}).join('');
        }
        
        if (statusEl.textContent) {
          statusEl.textContent = '';
        }
      } catch (e) {
        mailboxList.innerHTML = `<p style="color:#dc3545;">❌ 加载失败: ${e.message}</p>`;
      }
    }

    // Save mailbox (add or update)
    async function saveMailboxForm() {
      const email = document.getElementById('newMailboxEmail').value.trim();
      const password = document.getElementById('newMailboxPassword').value;
      const provider = document.getElementById('newMailboxProvider').value;
      const editingId = document.getElementById('editingMailboxId').value;
      const statusEl = document.getElementById('mailboxListStatus');

      if (!email) {
        showStatus('mailboxListStatus', '请输入邮箱地址', 'error');
        return;
      }

      // Basic email validation
      if (!email.includes('@')) {
        showStatus('mailboxListStatus', '请输入有效的邮箱地址', 'error');
        return;
      }

      // Password required for new mailbox, optional for update
      if (!editingId && !password) {
        showStatus('mailboxListStatus', '请输入密码', 'error');
        return;
      }

      const isEditing = !!editingId;
      showStatus('mailboxListStatus', isEditing ? '正在更新邮箱...' : '正在添加邮箱...', 'info');

      try {
        let res;
        const data = { email, provider };
        if (password) {
          data.password = password;
        }
        
        if (isEditing) {
          res = await apiPut(`/api/mailboxes/${editingId}`, data);
        } else {
          data.password = password; // Password required for new
          res = await apiPost('/api/mailboxes', data);
        }

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.error || (isEditing ? 'Failed to update mailbox' : 'Failed to add mailbox'));
        }

        // Clear form and reset state
        clearMailboxForm();

        showStatus('mailboxListStatus', isEditing ? '✅ 邮箱更新成功' : '✅ 邮箱添加成功', 'success');
        
        // Reload mailbox list
        await loadMailboxes();
        
        // Clear success message after 3 seconds
        setTimeout(() => {
          const statusEl = document.getElementById('mailboxListStatus');
          if (statusEl.textContent.includes('成功')) {
            statusEl.textContent = '';
            statusEl.className = '';
          }
        }, 3000);
      } catch (e) {
        showStatus('mailboxListStatus', '❌ ' + (isEditing ? '更新' : '添加') + '失败: ' + e.message, 'error');
      }
    }

    // Edit a mailbox
    async function editMailbox(mailboxId) {
      showStatus('mailboxListStatus', '正在加载邮箱信息...', 'info');

      try {
        // Get mailbox info
        const listRes = await apiGet('/api/mailboxes');
        if (!listRes.ok) {
          throw new Error('Failed to load mailbox');
        }
        const listData = await listRes.json();
        const mailbox = (listData.mailboxes || []).find(m => m.id === mailboxId);
        
        if (!mailbox) {
          throw new Error('Mailbox not found');
        }

        // Fill form
        document.getElementById('newMailboxEmail').value = mailbox.email;
        document.getElementById('newMailboxProvider').value = mailbox.provider || 'yahoo';
        document.getElementById('newMailboxPassword').value = ''; // Don't show password
        document.getElementById('editingMailboxId').value = mailboxId;
        
        // Update UI
        document.getElementById('mailboxFormTitle').textContent = '✏️ 编辑邮箱';
        document.getElementById('saveMailboxBtn').textContent = '更新邮箱';
        document.getElementById('saveMailboxBtn').style.background = '#17a2b8';
        document.getElementById('cancelMailboxBtn').style.display = 'inline-block';
        document.getElementById('passwordHint').textContent = '留空则保持原密码不变';
        
        updateMailboxPlaceholder();
        
        showStatus('mailboxListStatus', '📝 正在编辑邮箱，修改后点击"更新邮箱"保存', 'info');
        
        // Scroll to form
        document.getElementById('savedMailboxesCard').scrollIntoView({ behavior: 'smooth', block: 'center' });
      } catch (e) {
        showStatus('mailboxListStatus', '❌ 加载失败: ' + e.message, 'error');
      }
    }

    // Cancel mailbox edit
    function cancelMailboxEdit() {
      clearMailboxForm();
      showStatus('mailboxListStatus', '', '');
    }

    // Clear mailbox form
    function clearMailboxForm() {
      document.getElementById('newMailboxEmail').value = '';
      document.getElementById('newMailboxPassword').value = '';
      document.getElementById('newMailboxProvider').value = 'yahoo';
      document.getElementById('editingMailboxId').value = '';
      
      document.getElementById('mailboxFormTitle').textContent = '➕ 添加新邮箱';
      document.getElementById('saveMailboxBtn').textContent = '添加邮箱';
      document.getElementById('saveMailboxBtn').style.background = '';
      document.getElementById('cancelMailboxBtn').style.display = 'none';
      
      updateMailboxPlaceholder();
    }

    // Legacy function - redirects to new function
    async function addMailbox() {
      await saveMailboxForm();
    }

    // Delete a mailbox
    async function deleteMailbox(mailboxId, email) {
      if (!confirm(`确定要删除邮箱 "${email}" 吗？\n\n此操作不可撤销。`)) {
        return;
      }

      showStatus('mailboxListStatus', '正在删除...', 'info');

      try {
        const res = await apiDelete(`/api/mailboxes/${mailboxId}`);

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.error || 'Failed to delete mailbox');
        }

        showStatus('mailboxListStatus', '✅ 邮箱已删除', 'success');
        
        // Reload mailbox list
        await loadMailboxes();
        
        // Clear success message after 3 seconds
        setTimeout(() => {
          const statusEl = document.getElementById('mailboxListStatus');
          if (statusEl.textContent.includes('删除')) {
            statusEl.textContent = '';
            statusEl.className = '';
          }
        }, 3000);
      } catch (e) {
        showStatus('mailboxListStatus', '❌ 删除失败: ' + e.message, 'error');
      }
    }

    // Use a saved mailbox (auto-fill credentials)
    async function useMailbox(mailboxId) {
      showStatus('mailboxListStatus', '正在加载邮箱信息...', 'info');

      try {
        // Get the decrypted password
        const res = await apiGet(`/api/mailboxes/${mailboxId}/password`);

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.error || 'Failed to get mailbox credentials');
        }

        const data = await res.json();

        // Auto-fill the connection form
        document.getElementById('email').value = data.email;
        document.getElementById('password').value = data.password;

        showStatus('mailboxListStatus', '✅ 已填充邮箱信息，请点击"连接"按钮', 'success');
        
        // Scroll to connection card
        document.getElementById('connectionCard').scrollIntoView({ behavior: 'smooth' });
        
        // Clear success message after 5 seconds
        setTimeout(() => {
          const statusEl = document.getElementById('mailboxListStatus');
          if (statusEl.textContent.includes('填充')) {
            statusEl.textContent = '';
            statusEl.className = '';
          }
        }, 5000);
      } catch (e) {
        showStatus('mailboxListStatus', '❌ 加载失败: ' + e.message, 'error');
      }
    }

    // ==================== Navigation Functions ====================
    
    // Current active module
    let currentModule = 'mailbox-management';
    
    // Switch between feature modules
    function switchModule(moduleName) {
      // Update current module
      currentModule = moduleName;
      
      // Hide all modules
      const modules = document.querySelectorAll('.feature-module');
      modules.forEach(module => {
        module.classList.remove('active');
      });
      
      // Show selected module
      const targetModule = document.getElementById('module-' + moduleName);
      if (targetModule) {
        targetModule.classList.add('active');
      }
      
      // Update navigation item highlighting
      const navItems = document.querySelectorAll('.nav-item');
      navItems.forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-module') === moduleName) {
          item.classList.add('active');
        }
      });
      
      // Load pattern history when switching to extraction module
      if (moduleName === 'extraction') {
        loadPatternHistory();
      }
      
      // Initialize email management when switching to that module
      if (moduleName === 'email-management') {
        initEmailManagement();
      }
      
      // Close mobile menu after switching (on mobile devices)
      closeMobileMenu();
    }
    
    // ==================== Mobile Menu Functions ====================
    
    // Toggle mobile menu
    function toggleMobileMenu() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('mobileOverlay');
      const isOpen = sidebar.classList.contains('mobile-open');
      
      if (isOpen) {
        closeMobileMenu();
      } else {
        sidebar.classList.add('mobile-open');
        overlay.classList.add('visible');
      }
    }
    
    // Close mobile menu
    function closeMobileMenu() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('mobileOverlay');
      sidebar.classList.remove('mobile-open');
      overlay.classList.remove('visible');
    }

    // ==================== Email Management Functions ====================
    
    // Email management state
    let emailMgmtState = {
      currentFolder: null,
      folders: [],
      emails: [],
      selectedUids: new Set(),
      pagination: {
        page: 1,
        pageSize: 20,
        totalCount: 0,
        totalPages: 0
      },
      searchPattern: '',
      isSearchMode: false,
      sortOrder: 'desc' // 'desc' = newest first, 'asc' = oldest first
    };
    
    // Initialize email management module
    function initEmailManagement() {
      const connectionNotice = document.getElementById('emailMgmtConnectionNotice');
      const content = document.getElementById('emailMgmtContent');
      
      if (!sessionId) {
        // Not connected - show notice
        connectionNotice.style.display = 'block';
        content.style.display = 'none';
      } else {
        // Connected - show content and load folders
        connectionNotice.style.display = 'none';
        content.style.display = 'block';
        loadEmailFolders();
      }
    }
    
    // Load email folders
    async function loadEmailFolders() {
      const folderList = document.getElementById('emailFolderList');
      
      if (!sessionId) {
        folderList.innerHTML = '<p style="color:#666; font-size:13px;">请先连接邮箱</p>';
        return;
      }
      
      // Get folders from the folder select in extraction module
      const folderSelect = document.getElementById('folder');
      let folders = Array.from(folderSelect.options).map(opt => opt.value);
      
      // Filter out virtual parent folders that can't be selected (like [Gmail])
      // These are folders that have children but can't contain emails themselves
      const virtualFolders = ['[Gmail]', '[Google Mail]'];
      folders = folders.filter(f => !virtualFolders.includes(f));
      
      if (folders.length === 0) {
        folderList.innerHTML = '<p style="color:#666; font-size:13px;">没有找到文件夹</p>';
        return;
      }
      
      emailMgmtState.folders = folders;
      
      // Render folder list
      folderList.innerHTML = folders.map(folder => {
        const icon = getFolderIcon(folder);
        const isActive = emailMgmtState.currentFolder === folder;
        return `
          <div class="folder-item ${isActive ? 'active' : ''}" onclick="selectEmailFolder('${escapeHtml(folder)}')">
            <span class="folder-icon">${icon}</span>
            <span class="folder-name">${escapeHtml(folder)}</span>
          </div>
        `;
      }).join('');
      
      // Auto-select INBOX if no folder selected
      if (!emailMgmtState.currentFolder && folders.includes('INBOX')) {
        selectEmailFolder('INBOX');
      }
    }
    
    // Get icon for folder name
    function getFolderIcon(folderName) {
      const name = folderName.toLowerCase();
      if (name === 'inbox') return '📥';
      if (name.includes('sent')) return '📤';
      if (name.includes('draft')) return '📝';
      if (name.includes('trash') || name.includes('deleted')) return '🗑️';
      if (name.includes('spam') || name.includes('junk')) return '⚠️';
      if (name.includes('archive')) return '📦';
      return '📁';
    }
    
    // Select a folder and load emails
    async function selectEmailFolder(folder) {
      emailMgmtState.currentFolder = folder;
      emailMgmtState.pagination.page = 1;
      emailMgmtState.selectedUids.clear();
      emailMgmtState.isSearchMode = false;
      emailMgmtState.searchPattern = '';
      document.getElementById('emailSearchPattern').value = '';
      
      // Update folder list UI
      const folderItems = document.querySelectorAll('.folder-item');
      folderItems.forEach(item => {
        item.classList.remove('active');
        if (item.textContent.includes(folder)) {
          item.classList.add('active');
        }
      });
      
      await loadEmailList();
    }
    
    // Load email list for current folder
    async function loadEmailList() {
      const tableBody = document.getElementById('emailTableBody');
      const statusEl = document.getElementById('emailListStatus');
      
      if (!sessionId || !emailMgmtState.currentFolder) {
        tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:30px; color:#666;">选择一个文件夹以查看邮件</td></tr>';
        return;
      }
      
      statusEl.textContent = '加载中...';
      tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:30px; color:#666;">⏳ 正在加载邮件...</td></tr>';
      
      try {
        const endpoint = emailMgmtState.isSearchMode ? '/api/emails/search' : '/api/emails/list';
        const body = {
          sessionId,
          folder: emailMgmtState.currentFolder,
          page: emailMgmtState.pagination.page,
          pageSize: emailMgmtState.pagination.pageSize,
          sortOrder: emailMgmtState.sortOrder
        };
        
        if (emailMgmtState.isSearchMode && emailMgmtState.searchPattern) {
          body.subjectPattern = emailMgmtState.searchPattern;
        }
        
        const res = await apiPost(endpoint, body);
        
        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.error || 'Failed to load emails');
        }
        
        const data = await res.json();
        emailMgmtState.emails = data.emails || [];
        emailMgmtState.pagination = data.pagination || {
          page: 1,
          pageSize: 20,
          totalCount: 0,
          totalPages: 0
        };
        
        renderEmailList();
        updatePaginationUI();
        updateSelectedCount();
        
        const searchInfo = emailMgmtState.isSearchMode ? ` (搜索: "${emailMgmtState.searchPattern}")` : '';
        statusEl.textContent = `共 ${emailMgmtState.pagination.totalCount} 封邮件${searchInfo}`;
      } catch (e) {
        tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:30px; color:#dc3545;">❌ 加载失败: ${escapeHtml(e.message)}</td></tr>`;
        statusEl.textContent = '加载失败';
      }
    }
    
    // Render email list table
    function renderEmailList() {
      const tableBody = document.getElementById('emailTableBody');
      const emails = emailMgmtState.emails;
      
      if (emails.length === 0) {
        const message = emailMgmtState.isSearchMode ? '没有找到匹配的邮件' : '此文件夹为空';
        tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:30px; color:#666;">${message}</td></tr>`;
        return;
      }
      
      tableBody.innerHTML = emails.map(email => {
        const isSelected = emailMgmtState.selectedUids.has(email.uid);
        const date = new Date(email.date);
        const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        return `
          <tr class="email-row ${isSelected ? 'selected' : ''}" data-uid="${email.uid}" onclick="viewEmailContent(${email.uid}, '${escapeHtml(email.subject).replace(/'/g, "\\'")}', '${escapeHtml(email.sender).replace(/'/g, "\\'")}', '${escapeHtml(email.recipient || '').replace(/'/g, "\\'")}', '${escapeHtml(dateStr).replace(/'/g, "\\'")}')">
            <td style="text-align:center;">
              <input type="checkbox" class="email-checkbox" ${isSelected ? 'checked' : ''} 
                     onchange="toggleEmailSelection(${email.uid}, this.checked)" 
                     onclick="event.stopPropagation()">
            </td>
            <td class="email-date">${escapeHtml(dateStr)}</td>
            <td class="email-sender" title="${escapeHtml(email.sender)}">${escapeHtml(email.sender)}</td>
            <td class="email-subject" title="${escapeHtml(email.subject)}">${escapeHtml(email.subject || '(无主题)')}</td>
          </tr>
        `;
      }).join('');
    }
    
    // Toggle email selection
    function toggleEmailSelection(uid, isSelected) {
      if (isSelected) {
        emailMgmtState.selectedUids.add(uid);
      } else {
        emailMgmtState.selectedUids.delete(uid);
      }
      
      // Update row styling
      const row = document.querySelector(`tr[data-uid="${uid}"]`);
      if (row) {
        row.classList.toggle('selected', isSelected);
      }
      
      updateSelectedCount();
      updateSelectAllCheckbox();
    }
    
    // Toggle select all emails
    function toggleSelectAllEmails() {
      const selectAll = document.getElementById('selectAllEmails');
      const isChecked = selectAll.checked;
      
      emailMgmtState.emails.forEach(email => {
        if (isChecked) {
          emailMgmtState.selectedUids.add(email.uid);
        } else {
          emailMgmtState.selectedUids.delete(email.uid);
        }
      });
      
      // Update all checkboxes
      const checkboxes = document.querySelectorAll('.email-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = isChecked;
      });
      
      // Update row styling
      const rows = document.querySelectorAll('.email-row');
      rows.forEach(row => {
        row.classList.toggle('selected', isChecked);
      });
      
      updateSelectedCount();
    }
    
    // Update select all checkbox state
    function updateSelectAllCheckbox() {
      const selectAll = document.getElementById('selectAllEmails');
      const totalOnPage = emailMgmtState.emails.length;
      const selectedOnPage = emailMgmtState.emails.filter(e => emailMgmtState.selectedUids.has(e.uid)).length;
      
      selectAll.checked = totalOnPage > 0 && selectedOnPage === totalOnPage;
      selectAll.indeterminate = selectedOnPage > 0 && selectedOnPage < totalOnPage;
    }
    
    // Update selected count display
    function updateSelectedCount() {
      const count = emailMgmtState.selectedUids.size;
      document.getElementById('selectedCount').textContent = count;
      document.getElementById('btnBatchDelete').disabled = count === 0;
    }
    
    // Update pagination UI
    function updatePaginationUI() {
      const { page, pageSize, totalCount, totalPages } = emailMgmtState.pagination;
      
      const start = totalCount === 0 ? 0 : (page - 1) * pageSize + 1;
      const end = Math.min(page * pageSize, totalCount);
      
      document.getElementById('paginationInfo').textContent = 
        totalCount === 0 ? '没有邮件' : `显示 ${start}-${end} / 共 ${totalCount} 封`;
      document.getElementById('pageIndicator').textContent = `第 ${page} / ${totalPages || 1} 页`;
      
      document.getElementById('btnPrevPage').disabled = page <= 1;
      document.getElementById('btnNextPage').disabled = page >= totalPages;
      
      document.getElementById('pageSizeSelect').value = pageSize;
    }
    
    // Go to email page
    async function goToEmailPage(direction) {
      if (direction === 'prev' && emailMgmtState.pagination.page > 1) {
        emailMgmtState.pagination.page--;
      } else if (direction === 'next' && emailMgmtState.pagination.page < emailMgmtState.pagination.totalPages) {
        emailMgmtState.pagination.page++;
      }
      
      emailMgmtState.selectedUids.clear();
      document.getElementById('selectAllEmails').checked = false;
      
      await loadEmailList();
    }
    
    // Change page size
    async function changePageSize() {
      const newSize = parseInt(document.getElementById('pageSizeSelect').value);
      emailMgmtState.pagination.pageSize = newSize;
      emailMgmtState.pagination.page = 1;
      emailMgmtState.selectedUids.clear();
      document.getElementById('selectAllEmails').checked = false;
      
      await loadEmailList();
    }
    
    // Search emails by subject pattern
    async function searchEmails() {
      const pattern = document.getElementById('emailSearchPattern').value.trim();
      
      if (!pattern) {
        clearEmailSearch();
        return;
      }
      
      emailMgmtState.searchPattern = pattern;
      emailMgmtState.isSearchMode = true;
      emailMgmtState.pagination.page = 1;
      emailMgmtState.selectedUids.clear();
      document.getElementById('selectAllEmails').checked = false;
      
      await loadEmailList();
    }
    
    // Clear email search
    async function clearEmailSearch() {
      document.getElementById('emailSearchPattern').value = '';
      emailMgmtState.searchPattern = '';
      emailMgmtState.isSearchMode = false;
      emailMgmtState.pagination.page = 1;
      emailMgmtState.selectedUids.clear();
      document.getElementById('selectAllEmails').checked = false;
      
      await loadEmailList();
    }
    
    // Refresh email list
    async function refreshEmailList() {
      emailMgmtState.selectedUids.clear();
      document.getElementById('selectAllEmails').checked = false;
      await loadEmailList();
    }
    
    // Batch delete selected emails
    async function batchDeleteSelectedEmails() {
      const uids = Array.from(emailMgmtState.selectedUids);
      
      if (uids.length === 0) {
        alert('请先选择要删除的邮件');
        return;
      }
      
      if (!confirm(`确定要删除选中的 ${uids.length} 封邮件吗？\n\n邮件将被移至回收站。`)) {
        return;
      }
      
      const statusEl = document.getElementById('emailListStatus');
      statusEl.textContent = '正在删除...';
      
      try {
        const res = await apiPost('/api/emails/batch-delete', {
          sessionId,
          folder: emailMgmtState.currentFolder,
          uids
        });
        
        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.error || 'Failed to delete emails');
        }
        
        const data = await res.json();
        
        statusEl.textContent = `✅ ${data.message}`;
        
        // Clear selection and refresh
        emailMgmtState.selectedUids.clear();
        document.getElementById('selectAllEmails').checked = false;
        
        // Refresh email list
        await loadEmailList();
        
        // Clear success message after 3 seconds
        setTimeout(() => {
          if (statusEl.textContent.includes('成功')) {
            statusEl.textContent = `共 ${emailMgmtState.pagination.totalCount} 封邮件`;
          }
        }, 3000);
      } catch (e) {
        statusEl.textContent = `❌ 删除失败: ${e.message}`;
      }
    }
    
    // Empty trash from email management module
    async function emptyTrashFromMgmt() {
      if (!confirm('⚠️ 警告：这将永久删除回收站中的所有邮件！\n\n此操作不可撤销！\n\n确定要继续吗？')) {
        return;
      }
      
      const statusEl = document.getElementById('emailListStatus');
      statusEl.textContent = '正在清空回收站...';
      
      try {
        const res = await apiPost('/api/empty-trash', { sessionId });
        
        const data = await res.json();
        
        if (data.error) {
          statusEl.textContent = `❌ 清空失败: ${data.error}`;
        } else {
          statusEl.textContent = `✅ ${data.message}`;
          
          // Refresh if currently viewing trash
          const currentFolder = emailMgmtState.currentFolder?.toLowerCase() || '';
          if (currentFolder.includes('trash') || currentFolder.includes('deleted')) {
            await loadEmailList();
          }
          
          // Clear success message after 3 seconds
          setTimeout(() => {
            if (statusEl.textContent.includes('成功') || statusEl.textContent.includes('清空')) {
              statusEl.textContent = `共 ${emailMgmtState.pagination.totalCount} 封邮件`;
            }
          }, 3000);
        }
      } catch (e) {
        statusEl.textContent = `❌ 清空失败: ${e.message}`;
      }
    }
    
    // Change email sort order
    async function changeEmailSortOrder() {
      const newOrder = document.getElementById('emailSortOrder').value;
      emailMgmtState.sortOrder = newOrder;
      emailMgmtState.pagination.page = 1;
      emailMgmtState.selectedUids.clear();
      document.getElementById('selectAllEmails').checked = false;
      
      await loadEmailList();
    }
    
    // View email content in modal
    async function viewEmailContent(uid, subject, sender, recipient, dateStr) {
      const modal = document.getElementById('emailModal');
      const modalSubject = document.getElementById('emailModalSubject');
      const modalFrom = document.getElementById('emailModalFrom');
      const modalTo = document.getElementById('emailModalTo');
      const modalDate = document.getElementById('emailModalDate');
      const modalBody = document.getElementById('emailModalBody');
      
      // Set header info
      modalSubject.textContent = subject || '(无主题)';
      modalFrom.textContent = sender || '(未知发件人)';
      modalTo.textContent = recipient || '(未知收件人)';
      modalDate.textContent = dateStr || '';
      
      // Show modal with loading state
      modalBody.innerHTML = '<div class="email-modal-loading">⏳ 正在加载邮件内容...</div>';
      modal.classList.add('visible');
      
      try {
        const res = await apiPost('/api/emails/content', {
          sessionId,
          folder: emailMgmtState.currentFolder,
          uid
        });
        
        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.error || 'Failed to load email content');
        }
        
        const data = await res.json();
        
        if (data.content) {
          // Check if content is HTML
          if (data.isHtml) {
            // Create a sandboxed iframe for HTML content
            modalBody.innerHTML = `
              <iframe 
                srcdoc="${escapeHtml(data.content)}" 
                style="width:100%; height:400px; border:1px solid #e0e0e0; border-radius:4px;"
                sandbox="allow-same-origin"
              ></iframe>
              <div style="margin-top:10px;">
                <button class="btn-secondary" onclick="toggleEmailRawContent()" style="font-size:12px; padding:6px 12px;">
                  查看原始内容
                </button>
              </div>
              <pre id="emailRawContent" style="display:none; margin-top:10px; padding:10px; background:#f5f5f5; border-radius:4px; font-size:12px; max-height:300px; overflow:auto;">${escapeHtml(data.rawContent || data.content)}</pre>
            `;
          } else {
            // Plain text content
            modalBody.innerHTML = `<pre>${escapeHtml(data.content)}</pre>`;
          }
        } else {
          modalBody.innerHTML = '<div style="text-align:center; color:#666; padding:20px;">邮件内容为空</div>';
        }
      } catch (e) {
        modalBody.innerHTML = `<div style="text-align:center; color:#dc3545; padding:20px;">❌ 加载失败: ${escapeHtml(e.message)}</div>`;
      }
    }
    
    // Toggle raw email content display
    function toggleEmailRawContent() {
      const rawContent = document.getElementById('emailRawContent');
      if (rawContent) {
        rawContent.style.display = rawContent.style.display === 'none' ? 'block' : 'none';
      }
    }
    
    // Close email modal
    function closeEmailModal(event) {
      if (event && event.target !== event.currentTarget) {
        return;
      }
      document.getElementById('emailModal').classList.remove('visible');
    }

    // ==================== Rule History Functions ====================
    // Requirements: 1.1, 1.2, 1.3, 5.1
    
    // Store all rules for filtering
    let allRules = [];
    let currentRuleTagFilter = '';
    let ruleHistoryCollapsed = false;
    
    // Toggle rule history panel collapse
    function toggleRuleHistoryPanel() {
      ruleHistoryCollapsed = !ruleHistoryCollapsed;
      const content = document.getElementById('ruleHistoryContent');
      const icon = document.getElementById('ruleHistoryToggleIcon');
      
      if (ruleHistoryCollapsed) {
        content.style.display = 'none';
        icon.textContent = '▶';
      } else {
        content.style.display = 'block';
        icon.textContent = '▼';
      }
    }
    
    // Load and display rule history
    // Requirements: 1.1 - Display list of saved extraction rules with pattern name, subject pattern, and tags
    async function loadRuleHistory() {
      const ruleList = document.getElementById('ruleHistoryList');
      const statusEl = document.getElementById('ruleHistoryStatus');
      const tagFilter = document.getElementById('ruleTagFilter');
      const tagSelect = document.getElementById('ruleTagSelect');
      const countEl = document.getElementById('ruleHistoryCount');
      
      if (!authToken) {
        ruleList.innerHTML = '<p style="color:#666;">请先登录</p>';
        return;
      }
      
      try {
        const res = await apiGet('/api/patterns');

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.error || 'Failed to load rules');
        }

        const data = await res.json();
        allRules = data.patterns || [];
        
        // Update count display
        countEl.textContent = `(${allRules.length} 条规则)`;
        
        // Collect all unique tags
        const allTags = new Set();
        allRules.forEach(r => {
          if (r.tags && Array.isArray(r.tags)) {
            r.tags.forEach(t => allTags.add(t));
          }
        });
        
        // Update tag filter dropdown
        if (allTags.size > 0) {
          tagFilter.style.display = 'block';
          const currentValue = tagSelect.value;
          tagSelect.innerHTML = '<option value="">全部</option>' + 
            Array.from(allTags).sort().map(tag => 
              `<option value="${escapeHtml(tag)}" ${tag === currentRuleTagFilter ? 'selected' : ''}>${escapeHtml(tag)}</option>`
            ).join('');
        } else {
          tagFilter.style.display = 'none';
        }
        
        // Filter rules by tag
        const filteredRules = currentRuleTagFilter 
          ? allRules.filter(r => r.tags && r.tags.includes(currentRuleTagFilter))
          : allRules;

        if (filteredRules.length === 0) {
          ruleList.innerHTML = `
            <div class="rule-empty">
              <p style="font-size:16px; margin-bottom:8px;">📝 ${currentRuleTagFilter ? '没有匹配的规则' : '还没有保存的规则'}</p>
              <p style="font-size:13px;">${currentRuleTagFilter ? '尝试选择其他标签' : '保存常用的提取规则以便快速应用'}</p>
            </div>
          `;
        } else {
          // Requirements: 1.1, 1.2 - Display pattern name, subject pattern, tags with Use and Delete buttons
          ruleList.innerHTML = filteredRules.map(rule => {
            const tagsHtml = rule.tags && rule.tags.length > 0 
              ? `<div class="rule-tags">${rule.tags.map(t => `<span class="rule-tag" onclick="event.stopPropagation(); filterRuleByTag('${escapeHtml(t)}')">${escapeHtml(t)}</span>`).join('')}</div>`
              : '';
            const ruleName = rule.patternName || '未命名规则';
            return `
            <div class="rule-item" data-id="${escapeHtml(rule.id)}">
              <div class="rule-info" onclick="useRuleFromHistory('${escapeHtml(rule.id)}')">
                <div class="rule-name">📋 ${escapeHtml(ruleName)}</div>
                <div class="rule-subject">主题: ${escapeHtml(rule.subjectPattern || '(无主题筛选)')}</div>
                <code class="rule-regex">${escapeHtml(rule.regexPattern)}</code>
                ${tagsHtml}
                <div class="rule-meta">
                  标志: ${escapeHtml(rule.regexFlags || 'g')} | 
                  创建于 ${new Date(rule.createdAt).toLocaleDateString()}
                  ${rule.lastUsed ? ' | 最后使用 ' + new Date(rule.lastUsed).toLocaleDateString() : ''}
                </div>
              </div>
              <div class="rule-actions">
                <button class="btn-use-rule" onclick="event.stopPropagation(); useRuleFromHistory('${escapeHtml(rule.id)}')">使用</button>
                <button class="btn-edit-rule" onclick="event.stopPropagation(); editRuleFromHistory('${escapeHtml(rule.id)}')">编辑</button>
                <button class="btn-delete-rule" onclick="event.stopPropagation(); deleteRuleFromHistory('${escapeHtml(rule.id)}', '${escapeHtml(ruleName).replace(/'/g, "\\'")}')">删除</button>
              </div>
            </div>
          `}).join('');
        }
        
        if (statusEl.textContent) {
          statusEl.textContent = '';
        }
      } catch (e) {
        ruleList.innerHTML = `<p style="color:#dc3545;">❌ 加载失败: ${e.message}</p>`;
      }
    }
    
    // Filter rules by tag (from dropdown)
    function filterRulesByTag() {
      currentRuleTagFilter = document.getElementById('ruleTagSelect').value;
      loadRuleHistory();
    }
    
    // Filter by clicking a tag
    function filterRuleByTag(tag) {
      currentRuleTagFilter = tag;
      document.getElementById('ruleTagSelect').value = tag;
      loadRuleHistory();
    }
    
    // Use rule from history - populate form with rule parameters
    // Requirements: 1.2, 5.1 - Click on saved rule to display full details and populate extraction form
    async function useRuleFromHistory(ruleId) {
      const statusEl = document.getElementById('ruleHistoryStatus');
      
      try {
        // Find the rule in cached data
        const rule = allRules.find(r => r.id === ruleId);
        
        if (!rule) {
          showStatus('ruleHistoryStatus', '❌ 规则不存在', 'error');
          return;
        }

        // Populate the rule editor form with rule parameters
        document.getElementById('pattern').value = rule.regexPattern;
        document.getElementById('patternFlags').value = rule.regexFlags || 'g';
        document.getElementById('patternName').value = rule.patternName || 'default';
        document.getElementById('patternTags').value = (rule.tags || []).join(', ');
        
        // Populate subject pattern in both the rule editor and filter fields
        if (rule.subjectPattern) {
          const ruleSubjectPattern = document.getElementById('ruleSubjectPattern');
          if (ruleSubjectPattern) {
            ruleSubjectPattern.value = rule.subjectPattern;
          }
          document.getElementById('subject').value = rule.subjectPattern;
        }

        // Update current rule display in extraction options
        updateCurrentRuleDisplay(
          rule.patternName,
          rule.subjectPattern,
          rule.regexPattern,
          rule.regexFlags || 'g',
          (rule.tags || []).join(', ')
        );

        showStatus('ruleHistoryStatus', '✅ 已应用规则到表单', 'success');
        showRuleEditorStatus('✅ 已加载规则: ' + (rule.patternName || '未命名'), 'success');
        
        // Update last used timestamp via API
        try {
          await apiPut(`/api/patterns/${ruleId}/use`, {});
          // Refresh the list to show updated lastUsed
          await loadRuleHistory();
        } catch (e) {
          console.log('Failed to update last used:', e);
        }
        
        // Scroll to extraction options card
        document.getElementById('extractionOptionsCard').scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Clear success message after 3 seconds
        setTimeout(() => {
          const statusEl = document.getElementById('ruleHistoryStatus');
          if (statusEl.textContent.includes('应用')) {
            statusEl.textContent = '';
            statusEl.className = '';
          }
        }, 3000);
      } catch (e) {
        showStatus('ruleHistoryStatus', '❌ 应用失败: ' + e.message, 'error');
      }
    }
    
    // Delete rule from history with confirmation
    // Requirements: 1.3 - Delete saved rule from storage and update display
    async function deleteRuleFromHistory(ruleId, ruleName) {
      if (!confirm(`确定要删除规则 "${ruleName}" 吗？\n\n此操作不可撤销。`)) {
        return;
      }

      showStatus('ruleHistoryStatus', '正在删除...', 'info');

      try {
        const res = await apiDelete(`/api/patterns/${ruleId}`);

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.error || 'Failed to delete rule');
        }

        showStatus('ruleHistoryStatus', '✅ 规则已删除', 'success');
        
        // Reload rule history to update display
        await loadRuleHistory();
        
        // Clear success message after 3 seconds
        setTimeout(() => {
          const statusEl = document.getElementById('ruleHistoryStatus');
          if (statusEl.textContent.includes('删除')) {
            statusEl.textContent = '';
            statusEl.className = '';
          }
        }, 3000);
      } catch (e) {
        showStatus('ruleHistoryStatus', '❌ 删除失败: ' + e.message, 'error');
      }
    }

    // Track which rule is being edited
    let editingPatternId = null;

    /**
     * Edit a rule from history - load into editor for modification
     */
    async function editRuleFromHistory(ruleId) {
      const rule = allRules.find(r => r.id === ruleId);
      if (!rule) {
        showStatus('ruleHistoryStatus', '❌ 找不到规则', 'error');
        return;
      }

      // Set editing mode
      editingPatternId = ruleId;

      // Populate rule editor fields
      document.getElementById('patternName').value = rule.patternName || '';
      document.getElementById('ruleSubjectPattern').value = rule.subjectPattern || '';
      document.getElementById('pattern').value = rule.regexPattern || '';
      document.getElementById('patternFlags').value = rule.regexFlags || 'g';
      document.getElementById('patternTags').value = (rule.tags || []).join(', ');

      // Update save button text to indicate editing mode
      updateSaveButtonState();

      // Switch to extraction module and scroll to rule editor
      switchModule('extraction');
      setTimeout(() => {
        document.getElementById('ruleEditorCard').scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 100);

      showRuleEditorStatus('📝 正在编辑规则: ' + (rule.patternName || '未命名'), 'info');
      showStatus('ruleHistoryStatus', '📝 已加载规则到编辑器', 'info');
    }

    /**
     * Update save button to show editing state
     */
    function updateSaveButtonState() {
      const saveBtn = document.querySelector('#ruleEditorCard button[onclick="saveRuleToHistory()"]');
      if (saveBtn) {
        if (editingPatternId) {
          saveBtn.innerHTML = '💾 更新规则';
          saveBtn.style.background = '#17a2b8';
        } else {
          saveBtn.innerHTML = '💾 保存规则';
          saveBtn.style.background = '#6001d2';
        }
      }
    }

    // ==================== Legacy Pattern History Functions (for backward compatibility) ====================
    
    // Store all patterns for filtering
    let allPatterns = [];
    let currentTagFilter = '';
    
    // Load and display pattern history (legacy - calls new function)
    async function loadPatternHistory() {
      await loadRuleHistory();
    }
    
    // Filter patterns by tag (from dropdown) - legacy
    function filterPatternsByTag() {
      filterRulesByTag();
    }
    
    // Filter by clicking a tag - legacy
    function filterByTag(tag) {
      filterRuleByTag(tag);
    }

    /**
     * Save rule to history from the rule editor panel
     * Requirements: 4.6, 4.7 - Validate required fields, call POST /api/patterns to save,
     * refresh rule history list
     */
    async function saveRuleToHistory() {
      const regexPattern = document.getElementById('pattern').value.trim();
      const regexFlags = document.getElementById('patternFlags').value;
      const patternName = document.getElementById('patternName').value.trim();
      const tagsInput = document.getElementById('patternTags').value;
      
      // Get subject pattern from the new rule editor field, fallback to filter field
      const ruleSubjectPattern = document.getElementById('ruleSubjectPattern');
      const subjectPattern = ruleSubjectPattern ? ruleSubjectPattern.value.trim() : document.getElementById('subject').value.trim();

      // Validate required fields - Requirements: 4.7
      const errors = [];
      
      if (!patternName || patternName === 'default') {
        errors.push('请输入模式名称');
      }
      
      if (!regexPattern) {
        errors.push('请输入正则表达式');
      }
      
      if (errors.length > 0) {
        showRuleEditorStatus('❌ ' + errors.join(', '), 'error');
        return;
      }

      // Validate regex syntax
      try {
        new RegExp(regexPattern, regexFlags);
      } catch (e) {
        showRuleEditorStatus('❌ 正则表达式无效: ' + e.message, 'error');
        return;
      }
      
      // Parse tags
      const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t.length > 0) : [];

      const isEditing = !!editingPatternId;
      showRuleEditorStatus(isEditing ? '正在更新...' : '正在保存...', 'info');

      try {
        let res;
        if (isEditing) {
          // Update existing rule
          res = await apiPut(`/api/patterns/${editingPatternId}`, {
            patternName: patternName,
            subjectPattern: subjectPattern || '',
            regexPattern: regexPattern,
            regexFlags: regexFlags,
            tags: tags
          });
        } else {
          // Create new rule
          res = await apiPost('/api/patterns', {
            patternName: patternName,
            subjectPattern: subjectPattern || '',
            regexPattern: regexPattern,
            regexFlags: regexFlags,
            tags: tags
          });
        }

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.error || (isEditing ? 'Failed to update rule' : 'Failed to save rule'));
        }

        // Clear editing mode
        editingPatternId = null;
        updateSaveButtonState();

        showRuleEditorStatus(isEditing ? '✅ 规则已更新' : '✅ 规则已保存到历史', 'success');
        
        // Also show status in rule history section
        showStatus('ruleHistoryStatus', isEditing ? '✅ 规则已更新' : '✅ 规则已保存', 'success');
        
        // Reload rule history to show the new/updated rule
        await loadRuleHistory();
        
        // Clear success message after 3 seconds
        setTimeout(() => {
          const statusEl = document.getElementById('ruleHistoryStatus');
          if (statusEl.textContent.includes('保存') || statusEl.textContent.includes('更新')) {
            statusEl.textContent = '';
            statusEl.className = '';
          }
        }, 3000);
        
      } catch (e) {
        showRuleEditorStatus('❌ ' + (isEditing ? '更新' : '保存') + '失败: ' + e.message, 'error');
      }
    }

    // Save current pattern to server (legacy function - calls new saveRuleToHistory)
    async function savePatternToServer() {
      await saveRuleToHistory();
    }

    // Apply pattern from history to form (legacy - redirects to useRuleFromHistory)
    async function applyPatternFromHistory(patternId) {
      await useRuleFromHistory(patternId);
    }

    // Delete pattern from history (legacy - redirects to deleteRuleFromHistory)
    async function deletePatternFromHistory(patternId, patternName) {
      await deleteRuleFromHistory(patternId, patternName);
    }
    
    // Check if user is already authenticated on page load
    async function checkAuth() {
      const savedToken = sessionStorage.getItem('authToken');
      const savedUser = sessionStorage.getItem('currentUser');
      
      if (savedToken && savedUser) {
        try {
          // Temporarily set the token for the API call
          authToken = savedToken;
          
          // Verify token is still valid
          const res = await apiGet('/api/auth/me');

          if (res.ok) {
            const data = await res.json();
            currentUser = data.user;
            showMainApp();
            return;
          }
        } catch (e) {
          console.error('Auth check failed:', e);
        }
        
        // Token invalid, clear session
        authToken = null;
        sessionStorage.removeItem('authToken');
        sessionStorage.removeItem('currentUser');
      }
      
      // Show login page
      showLoginPage();
    }

    // ==================== Server Status ====================
    
    async function checkServerStatus() {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000);
        
        const res = await fetch(`${API}/api/connect`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: 'test', password: 'test' }),
          signal: controller.signal
        });
        clearTimeout(timeoutId);
        
        document.getElementById('serverStatus').innerHTML = '✅ 服务器运行中';
        document.getElementById('serverStatus').style.color = '#2e7d32';
      } catch (e) {
        if (e.name === 'AbortError') {
          document.getElementById('serverStatus').innerHTML = '⏳ 服务器响应缓慢，请稍候...';
          document.getElementById('serverStatus').style.color = '#ff9800';
        } else {
          document.getElementById('serverStatus').innerHTML = '❌ 服务器未响应<br><small>请运行: npm run web</small>';
          document.getElementById('serverStatus').style.color = '#dc3545';
        }
        console.error('Server check failed:', e.message);
      }
    }

    // ==================== Page Initialization ====================
    
    document.addEventListener('DOMContentLoaded', async () => {
      const delayInput = document.getElementById('delayMs');
      if (delayInput) {
        delayInput.addEventListener('input', (e) => {
          document.getElementById('delayValue').textContent = e.target.value + 'ms';
        });
      }

      // Check authentication status
      await checkAuth();
    });

    // ==================== Email Connection Functions ====================

    async function connect() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      if (!email || !password) {
        showStatus('connectionStatus', '请输入邮箱和密码', 'error');
        return;
      }

      showStatus('connectionStatus', '正在连接...', 'info');
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);
        
        // Use apiPost for connect - includes auth token
        const res = await apiRequest('/api/connect', {
          method: 'POST',
          body: JSON.stringify({ email, password }),
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!res.ok) {
          const error = await res.json();
          showStatus('connectionStatus', `连接失败: ${error.error || 'Unknown error'}`, 'error');
          return;
        }
        
        const data = await res.json();
        
        if (data.success) {
          sessionId = data.sessionId;
          document.getElementById('connectionForm').classList.add('hidden');
          document.getElementById('connectedInfo').classList.remove('hidden');
          document.getElementById('connectedEmail').textContent = email;
          
          // Filter out virtual parent folders (like [Gmail])
          const virtualFolders = ['[Gmail]', '[Google Mail]'];
          const validFolders = data.folders.filter(f => !virtualFolders.includes(f));
          
          const folderSelect = document.getElementById('folder');
          folderSelect.innerHTML = validFolders.map(f => `<option value="${f}">${f}</option>`).join('');
          
          showStatus('connectionStatus', '✅ 连接成功！', 'success');
          
          // Initialize email management if currently on that module
          if (currentModule === 'email-management') {
            initEmailManagement();
          }
        } else {
          showStatus('connectionStatus', `连接失败: ${data.error || 'Unknown error'}`, 'error');
        }
      } catch (e) {
        if (e.name === 'AbortError') {
          showStatus('connectionStatus', '❌ 连接超时 (30 秒)。请检查：\n1. 服务器是否运行 (npm run web)\n2. 网络连接\n3. Yahoo 邮箱和密码是否正确', 'error');
        } else {
          showStatus('connectionStatus', `❌ 连接错误: ${e.message}\n\n请检查：\n1. 服务器是否运行 (npm run web)\n2. 浏览器控制台 (F12) 查看详细错误`, 'error');
        }
        console.error('Connection error:', e);
      }
    }

    async function disconnect() {
      if (!confirm('确定要断开连接吗？')) {
        return;
      }

      try {
        if (sessionId) {
          const res = await apiPost('/api/disconnect', { sessionId });
          
          if (!res.ok) {
            console.error('Disconnect failed:', res.status);
          }
        }
        
        sessionId = null;
        document.getElementById('connectionForm').classList.remove('hidden');
        document.getElementById('connectedInfo').classList.add('hidden');
        document.getElementById('resultsCard').classList.add('hidden');
        document.getElementById('connectionStatus').innerHTML = '';
        
        document.getElementById('email').value = '';
        document.getElementById('password').value = '';
        
        // Reset email management state
        emailMgmtState = {
          currentFolder: null,
          folders: [],
          emails: [],
          selectedUids: new Set(),
          pagination: { page: 1, pageSize: 20, totalCount: 0, totalPages: 0 },
          searchPattern: '',
          isSearchMode: false,
          sortOrder: 'desc'
        };
        
        // Re-initialize email management if on that module
        if (currentModule === 'email-management') {
          initEmailManagement();
        }
        
        showStatus('connectionStatus', '✅ 已断开连接', 'success');
        setTimeout(() => {
          document.getElementById('connectionStatus').innerHTML = '';
        }, 3000);
      } catch (e) {
        console.error('Disconnect error:', e);
        showStatus('connectionStatus', '❌ 断开连接失败: ' + e.message, 'error');
      }
    }

    function getFilter() {
      return {
        folder: document.getElementById('folder').value,
        dateFrom: document.getElementById('dateFrom').value || undefined,
        dateTo: document.getElementById('dateTo').value || undefined,
        sender: document.getElementById('sender').value || undefined,
        subject: document.getElementById('subject').value || undefined
      };
    }

    async function countEmails() {
      const countResult = document.getElementById('countResult');
      countResult.classList.remove('hidden');
      countResult.textContent = '正在统计... (最多等待 30 秒)';
      countResult.className = 'status info';
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 35000);
        
        const res = await apiRequest('/api/count', {
          method: 'POST',
          body: JSON.stringify({ sessionId, filter: getFilter() }),
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.error || 'Count failed');
        }
        
        const data = await res.json();
        countResult.textContent = `✅ 找到 ${data.count} 封符合条件的邮件`;
        countResult.className = 'status success';
      } catch (e) {
        if (e.name === 'AbortError') {
          countResult.textContent = '❌ 统计超时，请检查网络连接或邮件数量过多';
        } else {
          countResult.textContent = '❌ 统计失败: ' + e.message;
        }
        countResult.className = 'status error';
      }
    }

    async function previewEmail() {
      const previewContainer = document.getElementById('previewContainer');
      const previewResult = document.getElementById('previewResult');
      previewContainer.classList.remove('hidden');
      previewResult.innerHTML = '正在获取预览...';
      
      // Reset search state
      clearPreviewSearch();
      
      try {
        const res = await apiPost('/api/preview', { sessionId, filter: getFilter() });
        
        const data = await res.json();
        if (data.error) {
          previewResult.innerHTML = escapeHtml('错误: ' + data.error);
        } else if (data.content) {
          // Store original content for search functionality
          previewEmailContent = data.content;
          previewEmailMetadata = {
            subject: data.subject,
            from: data.from,
            date: data.date,
            contentLength: data.contentLength
          };
          
          const preview = `=== 主题: ${data.subject} ===\n=== 发件人: ${data.from} ===\n=== 日期: ${data.date} ===\n=== 内容长度: ${data.contentLength} 字符 ===\n\n${data.content}`;
          previewResult.innerHTML = escapeHtml(preview);
          
          // Enable text selection for rule generation
          setupTextSelectionHandler();
        } else {
          previewResult.innerHTML = '没有找到邮件';
        }
      } catch (e) {
        previewResult.innerHTML = escapeHtml('预览失败: ' + e.message);
      }
    }

    // ==================== Email Preview Search Functions ====================
    // Requirements: 2.3, 2.4, 2.5
    
    // Store preview content and search state
    let previewEmailContent = '';
    let previewEmailMetadata = null;
    let previewSearchMatches = [];
    let previewCurrentMatchIndex = -1;
    let previewOriginalContent = '';
    
    /**
     * Handle keydown events in search input
     * Requirements: 2.4
     */
    function handlePreviewSearchKeydown(event) {
      if (event.key === 'Enter') {
        if (event.shiftKey) {
          navigatePreviewSearch('prev');
        } else {
          if (previewSearchMatches.length > 0) {
            navigatePreviewSearch('next');
          } else {
            searchInPreview();
          }
        }
        event.preventDefault();
      } else if (event.key === 'Escape') {
        clearPreviewSearch();
      }
    }
    
    /**
     * Search for text in the email preview
     * Requirements: 2.4 - WHEN the user searches in the preview THEN the System SHALL 
     * highlight all matching occurrences and navigate between them
     */
    function searchInPreview() {
      const searchInput = document.getElementById('previewSearchInput');
      const previewResult = document.getElementById('previewResult');
      const searchCount = document.getElementById('previewSearchCount');
      const prevBtn = document.getElementById('previewSearchPrev');
      const nextBtn = document.getElementById('previewSearchNext');
      
      const query = searchInput.value.trim();
      
      if (!query) {
        clearPreviewSearch();
        return;
      }
      
      // Get the full preview text (including metadata)
      const fullPreview = previewResult.textContent || previewResult.innerText;
      if (!fullPreview) {
        searchCount.textContent = '0/0';
        return;
      }
      
      // Store original content for restoration
      if (!previewOriginalContent) {
        previewOriginalContent = fullPreview;
      }
      
      // Find all matches (case-insensitive)
      previewSearchMatches = [];
      const lowerContent = fullPreview.toLowerCase();
      const lowerQuery = query.toLowerCase();
      let startIndex = 0;
      let foundIndex;
      
      while ((foundIndex = lowerContent.indexOf(lowerQuery, startIndex)) !== -1) {
        previewSearchMatches.push({
          index: foundIndex,
          length: query.length,
          text: fullPreview.substring(foundIndex, foundIndex + query.length)
        });
        startIndex = foundIndex + 1;
      }
      
      // Update UI
      if (previewSearchMatches.length === 0) {
        searchCount.textContent = '0/0';
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        previewResult.innerHTML = escapeHtml(fullPreview);
        return;
      }
      
      // Enable navigation buttons
      prevBtn.disabled = false;
      nextBtn.disabled = false;
      
      // Set current match to first one
      previewCurrentMatchIndex = 0;
      
      // Highlight all matches and show current
      highlightPreviewMatches(fullPreview, query);
      
      // Update count display
      updatePreviewSearchCount();
      
      // Scroll to first match
      scrollToCurrentMatch();
    }
    
    /**
     * Highlight all matches in the preview content
     * Requirements: 2.4
     */
    function highlightPreviewMatches(content, query) {
      const previewResult = document.getElementById('previewResult');
      
      if (previewSearchMatches.length === 0) {
        previewResult.innerHTML = escapeHtml(content);
        return;
      }
      
      // Build HTML with highlighted matches
      const htmlParts = [];
      let lastIndex = 0;
      
      for (let i = 0; i < previewSearchMatches.length; i++) {
        const match = previewSearchMatches[i];
        
        // Add text before this match (escaped)
        if (match.index > lastIndex) {
          htmlParts.push(escapeHtml(content.substring(lastIndex, match.index)));
        }
        
        // Add highlighted match with navigation data attribute
        const matchText = content.substring(match.index, match.index + match.length);
        const isCurrent = i === previewCurrentMatchIndex;
        htmlParts.push(
          `<span class="search-highlight${isCurrent ? ' current' : ''}" data-match-index="${i}">${escapeHtml(matchText)}</span>`
        );
        
        lastIndex = match.index + match.length;
      }
      
      // Add remaining text after last match
      if (lastIndex < content.length) {
        htmlParts.push(escapeHtml(content.substring(lastIndex)));
      }
      
      previewResult.innerHTML = htmlParts.join('');
    }
    
    /**
     * Navigate between search matches
     * Requirements: 2.4 - Navigate between matches with up/down buttons
     */
    function navigatePreviewSearch(direction) {
      if (previewSearchMatches.length === 0) {
        return;
      }
      
      // Update current match index
      if (direction === 'next') {
        previewCurrentMatchIndex = (previewCurrentMatchIndex + 1) % previewSearchMatches.length;
      } else {
        previewCurrentMatchIndex = previewCurrentMatchIndex <= 0 
          ? previewSearchMatches.length - 1 
          : previewCurrentMatchIndex - 1;
      }
      
      // Update highlight classes
      updateCurrentMatchHighlight();
      
      // Update count display
      updatePreviewSearchCount();
      
      // Scroll to current match
      scrollToCurrentMatch();
    }
    
    /**
     * Update the current match highlight
     */
    function updateCurrentMatchHighlight() {
      const previewResult = document.getElementById('previewResult');
      
      // Remove current class from all highlights
      const allHighlights = previewResult.querySelectorAll('.search-highlight');
      allHighlights.forEach(el => el.classList.remove('current'));
      
      // Add current class to current match
      const currentHighlight = previewResult.querySelector(`[data-match-index="${previewCurrentMatchIndex}"]`);
      if (currentHighlight) {
        currentHighlight.classList.add('current');
      }
    }
    
    /**
     * Scroll to the current match in the preview
     */
    function scrollToCurrentMatch() {
      const previewResult = document.getElementById('previewResult');
      const currentHighlight = previewResult.querySelector('.search-highlight.current');
      
      if (currentHighlight) {
        currentHighlight.scrollIntoView({
          behavior: 'smooth',
          block: 'center'
        });
      }
    }
    
    /**
     * Update the search count display
     */
    function updatePreviewSearchCount() {
      const searchCount = document.getElementById('previewSearchCount');
      if (previewSearchMatches.length === 0) {
        searchCount.textContent = '0/0';
      } else {
        searchCount.textContent = `${previewCurrentMatchIndex + 1}/${previewSearchMatches.length}`;
      }
    }
    
    /**
     * Clear the preview search
     */
    function clearPreviewSearch() {
      const searchInput = document.getElementById('previewSearchInput');
      const previewResult = document.getElementById('previewResult');
      const searchCount = document.getElementById('previewSearchCount');
      const prevBtn = document.getElementById('previewSearchPrev');
      const nextBtn = document.getElementById('previewSearchNext');
      
      // Clear search input
      searchInput.value = '';
      
      // Reset search state
      previewSearchMatches = [];
      previewCurrentMatchIndex = -1;
      
      // Restore original content if available
      if (previewOriginalContent) {
        previewResult.innerHTML = escapeHtml(previewOriginalContent);
      }
      previewOriginalContent = '';
      
      // Update UI
      searchCount.textContent = '0/0';
      prevBtn.disabled = true;
      nextBtn.disabled = true;
    }
    
    /**
     * Setup text selection handler for rule generation
     * Requirements: 2.5 - WHEN the user selects text in the preview THEN the System 
     * SHALL enable the "Generate Rule" action with the selected text
     */
    function setupTextSelectionHandler() {
      const previewResult = document.getElementById('previewResult');
      const generateBtn = document.getElementById('generateRuleBtn');
      
      // Handle selection change
      previewResult.addEventListener('mouseup', function() {
        const selection = window.getSelection();
        const selectedText = selection.toString().trim();
        
        if (selectedText && selectedText.length > 0) {
          generateBtn.disabled = false;
          generateBtn.title = `生成规则: "${selectedText.substring(0, 30)}${selectedText.length > 30 ? '...' : ''}"`;
        } else {
          generateBtn.disabled = true;
          generateBtn.title = '选择文本后可生成规则';
        }
      });
      
      // Also handle keyboard selection
      previewResult.addEventListener('keyup', function() {
        const selection = window.getSelection();
        const selectedText = selection.toString().trim();
        
        if (selectedText && selectedText.length > 0) {
          generateBtn.disabled = false;
        } else {
          generateBtn.disabled = true;
        }
      });
    }
    
    /**
     * Generate rule from selected text in preview
     * Requirements: 2.5 - Enable the "Generate Rule" action with the selected text
     */
    function generateRuleFromSelection() {
      const selection = window.getSelection();
      const selectedText = selection.toString().trim();
      
      if (!selectedText || selectedText.length === 0) {
        alert('请先在邮件预览中选择要提取的目标文本');
        return;
      }
      
      // Fill the target string input with selected text
      document.getElementById('targetString').value = selectedText;
      
      // Scroll to the rule editor card
      document.getElementById('ruleEditorCard').scrollIntoView({ behavior: 'smooth', block: 'start' });
      
      // Trigger the generate function
      setTimeout(() => {
        generateRuleFromTarget();
      }, 500);
    }

    // ==================== Extraction Functions ====================

    async function extract() {
      const pattern = document.getElementById('pattern').value;
      if (!pattern) {
        alert('请输入正则表达式');
        return;
      }

      try {
        new RegExp(pattern, document.getElementById('patternFlags').value);
      } catch (e) {
        alert('正则表达式无效: ' + e.message);
        return;
      }

      document.getElementById('resultsCard').classList.remove('hidden');
      showStatus('extractStatus', '正在提取... 请稍候（单线程处理）', 'info');
      
      document.getElementById('matchesList').innerHTML = '';
      document.getElementById('results').innerHTML = '';
      document.getElementById('progressBar').style.width = '0%';
      document.getElementById('progressPercent').textContent = '0%';
      document.getElementById('progressText').textContent = '准备中...';
      extractedResults = [];
      
      try {
        const delayMs = parseInt(document.getElementById('delayMs').value) || 100;
        // Use apiRequest for streaming endpoint
        const res = await apiRequest('/api/extract', {
          method: 'POST',
          body: JSON.stringify({
            sessionId,
            filter: getFilter(),
            pattern: {
              name: document.getElementById('patternName').value,
              pattern: pattern,
              flags: document.getElementById('patternFlags').value
            },
            stripHtml: document.getElementById('stripHtml').checked,
            delayMs: delayMs
          })
        });
        
        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let totalEmails = 0;
        let totalMatches = 0;
        let matchesList = [];

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          
          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop() || '';

          for (const line of lines) {
            if (!line) continue;
            
            try {
              const data = JSON.parse(line);
              
              if (data.type === 'init') {
                totalEmails = data.total;
                document.getElementById('progressText').textContent = `0 / ${totalEmails}`;
              } else if (data.type === 'progress') {
                const percent = Math.round((data.processed / totalEmails) * 100);
                document.getElementById('progressBar').style.width = percent + '%';
                document.getElementById('progressPercent').textContent = percent + '%';
                document.getElementById('progressText').textContent = `${data.processed} / ${totalEmails}`;
                
                if (data.matches && data.matches.length > 0) {
                  data.matches.forEach(match => {
                    totalMatches++;
                    matchesList.push(match);
                    
                    const matchHtml = `
                      <div style="padding:8px; margin:5px 0; background:white; border-radius:3px; border-left:3px solid #6001d2;">
                        <strong style="color:#6001d2;">${escapeHtml(match.fullMatch)}</strong>
                        <br><small style="color:#666;">📧 ${escapeHtml(match.subject)} | 👤 ${escapeHtml(match.from)}</small>
                      </div>
                    `;
                    document.getElementById('matchesList').innerHTML += matchHtml;
                    
                    const matchesDiv = document.getElementById('liveMatches');
                    matchesDiv.scrollTop = matchesDiv.scrollHeight;
                  });
                }
              } else if (data.type === 'complete') {
                extractedResults = data.results;
                showStatus('extractStatus', 
                  `✅ 完成！处理 ${data.processed} 封邮件，提取 ${totalMatches} 个匹配项，${data.errors} 个错误`, 
                  'success');
                renderResults(data.results);
              } else if (data.type === 'error') {
                showStatus('extractStatus', '❌ 错误: ' + data.error, 'error');
              }
            } catch (e) {
              console.error('Parse error:', e);
            }
          }
        }
      } catch (e) {
        showStatus('extractStatus', '提取失败: ' + e.message, 'error');
      }
    }

    function renderResults(results) {
      const container = document.getElementById('results');
      
      // Check if there are any results with matches
      const hasMatches = results.some(r => r.matches && r.matches.length > 0);
      
      if (!hasMatches) {
        // Requirements: 5.5 - Display clear message when no matches found
        container.innerHTML = `
          <div style="text-align:center; padding:30px; background:#f9f9f9; border-radius:6px; border:1px dashed #ddd;">
            <p style="font-size:48px; margin-bottom:10px;">📭</p>
            <h3 style="color:#666; margin-bottom:10px;">未找到匹配的折扣码</h3>
            <p style="color:#999; margin:0; font-size:14px;">根据当前的筛选条件和正则表达式，没有找到任何匹配的折扣码。</p>
            <p style="color:#999; margin:10px 0 0 0; font-size:13px;">请尝试调整筛选条件或修改正则表达式。</p>
          </div>
        `;
        return;
      }

      const groupNames = new Set();
      results.forEach(r => r.matches.forEach(m => Object.keys(m.groups).forEach(k => groupNames.add(k))));
      const groups = Array.from(groupNames);

      let html = '<table><thead><tr><th>日期</th><th>发件人</th><th>主题</th><th>匹配内容</th>';
      groups.forEach(g => html += `<th>${g}</th>`);
      html += '</tr></thead><tbody>';

      results.forEach(r => {
        if (r.matches.length === 0) return;
        r.matches.forEach((m, i) => {
          html += '<tr>';
          if (i === 0) {
            html += `<td rowspan="${r.matches.length}">${new Date(r.email.date).toLocaleDateString()}</td>`;
            html += `<td rowspan="${r.matches.length}">${escapeHtml(r.email.from)}</td>`;
            html += `<td rowspan="${r.matches.length}">${escapeHtml(r.email.subject)}</td>`;
          }
          html += `<td><span class="match">${escapeHtml(m.fullMatch)}</span></td>`;
          groups.forEach(g => html += `<td>${escapeHtml(m.groups[g] || '')}</td>`);
          html += '</tr>';
        });
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function exportCSV() {
      if (extractedResults.length === 0) {
        alert('没有可导出的数据');
        return;
      }

      const groupNames = new Set();
      extractedResults.forEach(r => r.matches.forEach(m => Object.keys(m.groups).forEach(k => groupNames.add(k))));
      const groups = Array.from(groupNames);

      let csv = 'Date,From,Subject,Match,' + groups.join(',') + '\n';
      
      extractedResults.forEach(r => {
        r.matches.forEach(m => {
          csv += `"${new Date(r.email.date).toISOString()}",`;
          csv += `"${r.email.from.replace(/"/g, '""')}",`;
          csv += `"${r.email.subject.replace(/"/g, '""')}",`;
          csv += `"${m.fullMatch.replace(/"/g, '""')}",`;
          csv += groups.map(g => `"${(m.groups[g] || '').replace(/"/g, '""')}"`).join(',');
          csv += '\n';
        });
      });

      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const now = new Date();
      const timestamp = now.toISOString().slice(0,10) + '_' + 
        now.getHours().toString().padStart(2,'0') + 
        now.getMinutes().toString().padStart(2,'0') + 
        now.getSeconds().toString().padStart(2,'0');
      a.download = 'extraction_' + timestamp + '.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    function showStatus(id, message, type) {
      const el = document.getElementById(id);
      el.className = 'status ' + type;
      el.textContent = message;
      el.style.whiteSpace = 'pre-wrap';
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    // ==================== Email Management Functions ====================

    async function deleteMatchingEmails() {
      const filter = getFilter();
      
      if (!filter.subject && !filter.sender && !filter.dateFrom && !filter.dateTo) {
        if (!confirm('⚠️ 警告：没有设置任何筛选条件！\n\n这将删除文件夹中的所有邮件！\n\n确定要继续吗？')) {
          return;
        }
      }

      const countResult = document.getElementById('countResult');
      if (!countResult.textContent.includes('找到')) {
        alert('请先点击"统计邮件数量"确认要删除的邮件数量');
        return;
      }

      const match = countResult.textContent.match(/(\d+)/);
      const count = match ? parseInt(match[1]) : 0;
      
      if (count === 0) {
        alert('没有找到匹配的邮件');
        return;
      }

      if (!confirm(`确定要删除 ${count} 封匹配的邮件吗？\n\n邮件将被移至回收站。`)) {
        return;
      }

      const managementResult = document.getElementById('managementResult');
      managementResult.classList.remove('hidden');
      managementResult.className = 'status info';
      managementResult.textContent = '正在删除邮件...';

      try {
        const res = await apiPost('/api/delete', { sessionId, filter });

        const data = await res.json();

        if (data.error) {
          managementResult.className = 'status error';
          managementResult.textContent = '❌ 删除失败: ' + data.error;
        } else {
          managementResult.className = 'status success';
          managementResult.textContent = '✅ ' + data.message;
          countEmails();
        }
      } catch (e) {
        managementResult.className = 'status error';
        managementResult.textContent = '❌ 删除失败: ' + e.message;
      }
    }

    async function emptyTrash() {
      if (!confirm('⚠️ 警告：这将永久删除回收站中的所有邮件！\n\n此操作不可撤销！\n\n确定要继续吗？')) {
        return;
      }

      const managementResult = document.getElementById('managementResult');
      managementResult.classList.remove('hidden');
      managementResult.className = 'status info';
      managementResult.textContent = '正在清空回收站...';

      try {
        const res = await apiPost('/api/empty-trash', { sessionId });

        const data = await res.json();

        if (data.error) {
          managementResult.className = 'status error';
          managementResult.textContent = '❌ 清空失败: ' + data.error;
        } else {
          managementResult.className = 'status success';
          managementResult.textContent = '✅ ' + data.message;
        }
      } catch (e) {
        managementResult.className = 'status error';
        managementResult.textContent = '❌ 清空失败: ' + e.message;
      }
    }

    async function getTrashCount() {
      const managementResult = document.getElementById('managementResult');
      managementResult.classList.remove('hidden');
      managementResult.className = 'status info';
      managementResult.textContent = '正在查询回收站...';

      try {
        const res = await apiPost('/api/trash-count', { sessionId });

        const data = await res.json();

        if (data.error) {
          managementResult.className = 'status error';
          managementResult.textContent = '❌ 查询失败: ' + data.error;
        } else if (data.message) {
          // Special message (e.g., no trash folder found)
          managementResult.className = 'status info';
          managementResult.textContent = `ℹ️ ${data.message}`;
        } else {
          managementResult.className = 'status success';
          managementResult.textContent = `📧 回收站中有 ${data.count} 封邮件`;
        }
      } catch (e) {
        managementResult.className = 'status error';
        managementResult.textContent = '❌ 查询失败: ' + e.message;
      }
    }

    // ==================== Settings Management ====================

    function saveSettings() {
      const settings = {
        email: document.getElementById('email').value,
        password: document.getElementById('password').value,
        filter: getFilter(),
        pattern: {
          name: document.getElementById('patternName').value,
          pattern: document.getElementById('pattern').value,
          flags: document.getElementById('patternFlags').value
        },
        stripHtml: document.getElementById('stripHtml').checked,
        delayMs: document.getElementById('delayMs').value
      };
      
      localStorage.setItem('extractorSettings', JSON.stringify(settings));
      alert('✅ 配置已保存到本地浏览器');
    }

    function loadSettings() {
      const saved = localStorage.getItem('extractorSettings');
      if (!saved) {
        alert('没有找到保存的配置');
        return;
      }
      
      try {
        const settings = JSON.parse(saved);
        document.getElementById('email').value = settings.email || '';
        document.getElementById('password').value = settings.password || '';
        document.getElementById('folder').value = settings.filter?.folder || 'INBOX';
        document.getElementById('sender').value = settings.filter?.sender || '';
        document.getElementById('subject').value = settings.filter?.subject || '';
        document.getElementById('dateFrom').value = settings.filter?.dateFrom ? settings.filter.dateFrom.split('T')[0] : '';
        document.getElementById('dateTo').value = settings.filter?.dateTo ? settings.filter.dateTo.split('T')[0] : '';
        document.getElementById('patternName').value = settings.pattern?.name || 'default';
        document.getElementById('pattern').value = settings.pattern?.pattern || '';
        document.getElementById('patternFlags').value = settings.pattern?.flags || 'g';
        document.getElementById('stripHtml').checked = settings.stripHtml || false;
        document.getElementById('delayMs').value = settings.delayMs || 100;
        document.getElementById('delayValue').textContent = (settings.delayMs || 100) + 'ms';
        
        alert('✅ 配置已加载');
      } catch (e) {
        alert('❌ 加载配置失败: ' + e.message);
      }
    }

    function savePattern() {
      const pattern = {
        name: document.getElementById('patternName').value,
        pattern: document.getElementById('pattern').value,
        flags: document.getElementById('patternFlags').value,
        subject: document.getElementById('subject').value,
        savedAt: new Date().toISOString()
      };
      
      let patterns = JSON.parse(localStorage.getItem('savedPatterns') || '[]');
      patterns.push(pattern);
      localStorage.setItem('savedPatterns', JSON.stringify(patterns));
      
      alert(`✅ 正则已保存 (共 ${patterns.length} 个)`);
    }

    // ==================== Rule Editor Functions ====================
    // Requirements: 3.1, 3.3, 3.4, 4.3, 4.4, 4.5, 4.6, 4.7

    /**
     * Generate rule from target string
     * Requirements: 3.1, 3.3, 3.4 - Call /api/regex/generate with target string,
     * populate regex field with generated pattern, show pattern suggestions
     */
    async function generateRuleFromTarget() {
      const targetString = document.getElementById('targetString').value.trim();
      const statusEl = document.getElementById('ruleEditorStatus');
      
      if (!targetString) {
        showRuleEditorStatus('请输入目标字符串', 'error');
        return;
      }

      // Use innerText to get plain text content (ignoring HTML tags from search highlights)
      const previewText = document.getElementById('previewResult').innerText || document.getElementById('previewResult').textContent;
      
      // Extract email content from preview (skip metadata headers)
      let emailContent = '';
      if (previewText) {
        const contentMatch = previewText.match(/===\s*内容长度:.*?\n\n([\s\S]*)/);
        emailContent = contentMatch ? contentMatch[1] : previewText;
      }

      showRuleEditorStatus('正在生成规则...', 'info');

      try {
        const res = await apiPost('/api/regex/generate', { 
          emailContent: emailContent || targetString, 
          targetString 
        });

        const data = await res.json();

        if (data.error) {
          showRuleEditorStatus('❌ ' + data.error, 'error');
          return;
        }

        // Also generate local smart patterns based on analysis
        const localPatterns = generateLocalSmartPatterns(targetString);
        
        // Merge local patterns with API patterns, avoiding duplicates
        const allPatterns = [...localPatterns];
        if (data.patterns) {
          for (const p of data.patterns) {
            // Check if pattern already exists
            if (!allPatterns.some(lp => lp.pattern === p.pattern)) {
              allPatterns.push(p);
            }
          }
        }

        // Display pattern suggestions
        const patternsList = document.getElementById('patternsList');
        let html = '';
        
        if (allPatterns.length > 0) {
          allPatterns.forEach((p, idx) => {
            const escapedPattern = p.pattern.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
            const escapedName = (p.name || '').replace(/'/g, "\\'");
            const isLocal = p.isLocal ? 'border-color:#6001d2; background:#f8f4ff;' : '';
            const icon = p.isLocal ? '🔧' : '🤖';
            html += `
              <div class="pattern-suggestion-item" style="${isLocal}" onclick="applyPatternSuggestion('${escapedPattern}', '${p.flags || 'gi'}', '${escapedName}')">
                <div class="pattern-name">${icon} ${escapeHtml(p.name || '建议规则 ' + (idx + 1))}</div>
                <code class="pattern-code">${escapeHtml(p.pattern)}</code>
                <div class="pattern-desc">${escapeHtml(p.description || '')}</div>
                <button onclick="event.stopPropagation(); applyPatternSuggestion('${escapedPattern}', '${p.flags || 'gi'}', '${escapedName}')" style="margin-top:8px; padding:5px 12px; font-size:12px; background:${p.isLocal ? '#6001d2' : '#28a745'};">✓ 应用</button>
              </div>
            `;
          });
        } else {
          // If no suggestions, create a literal pattern
          const literalPattern = escapeRegexSpecialChars(targetString);
          html = `
            <div class="pattern-suggestion-item" onclick="applyPatternSuggestion('${literalPattern.replace(/'/g, "\\'")}', 'g', '字面匹配')">
              <div class="pattern-name">字面匹配</div>
              <code class="pattern-code">${escapeHtml(literalPattern)}</code>
              <div class="pattern-desc">精确匹配目标字符串</div>
              <button onclick="event.stopPropagation(); applyPatternSuggestion('${literalPattern.replace(/'/g, "\\'")}', 'g', '字面匹配')" style="margin-top:8px; padding:5px 12px; font-size:12px; background:#28a745;">✓ 应用</button>
            </div>
          `;
        }

        patternsList.innerHTML = html;
        document.getElementById('generatedPatterns').classList.remove('hidden');
        
        // Auto-apply the first suggestion to the form
        if (allPatterns.length > 0) {
          const firstPattern = allPatterns[0];
          document.getElementById('pattern').value = firstPattern.pattern;
          document.getElementById('patternFlags').value = firstPattern.flags || 'gi';
          if (firstPattern.name && document.getElementById('patternName').value === 'default') {
            document.getElementById('patternName').value = firstPattern.name;
          }
          showRuleEditorStatus('✅ 已生成 ' + allPatterns.length + ' 个规则建议', 'success');
        } else {
          showRuleEditorStatus('✅ 已生成字面匹配规则', 'success');
        }
        
      } catch (e) {
        showRuleEditorStatus('❌ 生成规则失败: ' + e.message, 'error');
      }
    }
    
    /**
     * Generate local smart patterns based on target string analysis
     * This uses the same logic as the pattern builder modal
     */
    function generateLocalSmartPatterns(targetString) {
      const patterns = [];
      const analysis = analyzeTargetString(targetString);
      
      // Pattern 1: Full smart pattern with all detected parts
      let smartPattern = '';
      let description = '';
      
      // Add prefix if detected
      if (analysis.hasPrefix) {
        smartPattern += `(?:${escapeRegexSpecialChars(analysis.prefix)}|code|优惠码|折扣码)[：:\\s]*`;
        description += '前缀匹配 + ';
      }
      
      // Start capture group
      smartPattern += '(?<code>';
      
      // Add fixed part if detected
      if (analysis.hasFixed) {
        smartPattern += escapeRegexSpecialChars(analysis.fixed);
        description += `固定部分(${analysis.fixed}) + `;
        
        // Add separator if detected
        if (analysis.hasSeparator) {
          smartPattern += escapeRegexSpecialChars(analysis.separator);
          description += `分隔符(${analysis.separator}) + `;
        }
      }
      
      // Add variable part
      if (analysis.hasVariable) {
        const varLen = analysis.variable.length;
        const minLen = Math.max(varLen - 2, 4);
        const maxLen = varLen + 4;
        
        // Check if variable part contains separators
        if (analysis.separatorCount > 0 && !analysis.hasFixed) {
          // Variable part has internal separators
          smartPattern += `[A-Z0-9${escapeRegexSpecialChars(analysis.separator)}]{${minLen},${maxLen}}`;
          description += `变动部分(含${analysis.separator})`;
        } else {
          smartPattern += `[A-Z0-9]{${minLen},${maxLen}}`;
          description += '变动部分';
        }
      }
      
      // Close capture group
      smartPattern += ')';
      
      if (smartPattern !== '(?<code>)') {
        patterns.push({
          pattern: smartPattern,
          flags: 'gi',
          name: analysis.hasFixed ? `${analysis.fixed} 优惠码` : '智能匹配规则',
          description: description,
          isLocal: true
        });
      }
      
      // Pattern 2: If has separators, create a pattern that matches the structure
      if (analysis.hasSeparator && analysis.variable) {
        const parts = analysis.variable.split(analysis.separator);
        if (parts.length >= 2) {
          // Create pattern matching the segment structure
          const segmentPatterns = parts.map(p => `[A-Z0-9]{${Math.max(p.length - 1, 2)},${p.length + 2}}`);
          let structuredPattern = '';
          
          if (analysis.hasPrefix) {
            structuredPattern += `(?:${escapeRegexSpecialChars(analysis.prefix)}|code|优惠码)[：:\\s]*`;
          }
          
          structuredPattern += '(?<code>';
          if (analysis.hasFixed) {
            structuredPattern += escapeRegexSpecialChars(analysis.fixed) + escapeRegexSpecialChars(analysis.separator);
          }
          structuredPattern += segmentPatterns.join(escapeRegexSpecialChars(analysis.separator));
          structuredPattern += ')';
          
          patterns.push({
            pattern: structuredPattern,
            flags: 'gi',
            name: `${parts.length}段式优惠码`,
            description: `匹配 ${parts.length} 段用 "${analysis.separator}" 分隔的代码`,
            isLocal: true
          });
        }
      }
      
      // Pattern 3: Generic code pattern with common prefixes
      const genericPattern = `(?:code|优惠码|折扣码|兑换码|promo|coupon)[：:\\s]+(?<code>[A-Z0-9-_]{6,20})`;
      patterns.push({
        pattern: genericPattern,
        flags: 'gi',
        name: '通用优惠码',
        description: '匹配常见前缀后的优惠码',
        isLocal: true
      });
      
      return patterns;
    }

    /**
     * Apply a pattern suggestion to the rule editor form
     * Requirements: 3.4
     */
    function applyPatternSuggestion(pattern, flags, name) {
      document.getElementById('pattern').value = pattern;
      document.getElementById('patternFlags').value = flags || 'g';
      if (name && document.getElementById('patternName').value === 'default') {
        document.getElementById('patternName').value = name;
      }
      
      // 将筛选条件中的主题填充到规则编辑器的主题模式字段
      const subjectFilter = document.getElementById('subject').value.trim();
      const ruleSubjectPattern = document.getElementById('ruleSubjectPattern');
      if (subjectFilter && ruleSubjectPattern && !ruleSubjectPattern.value.trim()) {
        ruleSubjectPattern.value = subjectFilter;
      }
      
      showRuleEditorStatus('✅ 已应用规则: ' + (name || pattern.substring(0, 30)), 'success');
      
      // Scroll to the rule fields section
      document.querySelector('#ruleEditorCard .form-group').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    /**
     * Escape special regex characters in a string
     */
    function escapeRegexSpecialChars(str) {
      return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    /**
     * Show status message in rule editor
     */
    function showRuleEditorStatus(message, type) {
      const statusEl = document.getElementById('ruleEditorStatus');
      statusEl.textContent = message;
      statusEl.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#666';
      
      // Auto-clear success/info messages after 5 seconds
      if (type === 'success' || type === 'info') {
        setTimeout(() => {
          if (statusEl.textContent === message) {
            statusEl.textContent = '';
          }
        }, 5000);
      }
    }

    // Legacy function for backward compatibility
    async function generateRegex() {
      await generateRuleFromTarget();
    }

    function applyPattern(pattern, flags, name) {
      applyPatternSuggestion(pattern, flags, name);
    }

    // ==================== Pattern Builder Modal Functions ====================
    
    // Store the original target string and analyzed segments for the pattern builder
    let patternBuilderTarget = '';
    let patternBuilderSegments = [];
    let patternBuilderSeparator = '-';

    // Common fixed string patterns (brand names, campaign codes, month abbreviations, etc.)
    const COMMON_FIXED_PATTERNS = [
      // Brand/Campaign prefixes
      /^(BDAY|SMS|SMSUS|VIP|NEW|WELCOME|FIRST|SAVE|OFF|GET|FREE|DEAL|SALE|PROMO|CODE|GIFT|HOLIDAY|XMAS|CYBER|BLACK|FLASH)$/i,
      // Month abbreviations
      /^(JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)$/i,
      // Year patterns
      /^(FY\d{2,4}|20\d{2}|Q[1-4])$/i,
      // Short fixed codes (2-4 uppercase letters)
      /^[A-Z]{2,4}$/,
    ];

    /**
     * Check if a string looks like a fixed pattern
     */
    function isLikelyFixedPattern(str) {
      for (const pattern of COMMON_FIXED_PATTERNS) {
        if (pattern.test(str)) {
          return true;
        }
      }
      return false;
    }

    /**
     * Detect the character type of a string
     */
    function detectCharType(str) {
      if (/^\d+$/.test(str)) return 'numbers';
      if (/^[A-Z]+$/i.test(str)) return 'letters';
      return 'alphanumeric';
    }
    
    /**
     * Analyze target string and extract segments (new version)
     */
    function analyzeTargetString(target) {
      const result = {
        prefix: '',
        hasPrefix: false,
        separator: '',
        hasSeparator: false,
        segments: [],
        codeValue: ''
      };
      
      // Common prefix patterns
      const prefixPatterns = [
        /^(?:use\s+)?code[:\s]+/i,
        /^promo(?:\s+code)?[:\s]+/i,
        /^coupon(?:\s+code)?[:\s]+/i,
        /^discount(?:\s+code)?[:\s]+/i,
        /^(?:优惠码|折扣码|代码|兑换码|验证码)[：:\s]+/i
      ];
      
      let codeValue = target.trim();
      
      // Check for prefix
      for (const pattern of prefixPatterns) {
        const match = codeValue.match(pattern);
        if (match) {
          result.prefix = match[0].replace(/[:\s：]+$/, '');
          result.hasPrefix = true;
          codeValue = codeValue.substring(match[0].length).trim();
          break;
        }
      }
      
      result.codeValue = codeValue;
      
      // Check if code contains separator (- or _)
      if (codeValue.includes('-') || codeValue.includes('_')) {
        const dashCount = (codeValue.match(/-/g) || []).length;
        const underscoreCount = (codeValue.match(/_/g) || []).length;
        const sep = dashCount >= underscoreCount ? '-' : '_';
        result.separator = sep;
        result.hasSeparator = true;
        
        // Split into segments
        const parts = codeValue.split(sep);
        result.segments = parts.map((part, index) => {
          // First segment or common patterns are likely fixed
          const isFixed = index === 0 ? (isLikelyFixedPattern(part) || /^[A-Z]+$/i.test(part)) : isLikelyFixedPattern(part);
          
          return {
            value: part,
            length: part.length,
            isFixed: isFixed,
            type: isFixed ? 'fixed' : 'variable',
            charType: detectCharType(part)
          };
        });
      } else {
        // No separator - single segment
        result.segments = [{
          value: codeValue,
          length: codeValue.length,
          isFixed: isLikelyFixedPattern(codeValue),
          type: isLikelyFixedPattern(codeValue) ? 'fixed' : 'variable',
          charType: detectCharType(codeValue)
        }];
      }
      
      return result;
    }
    
    /**
     * Open the pattern builder modal (new version)
     */
    function openPatternBuilder() {
      const targetString = document.getElementById('targetString').value.trim();
      
      if (!targetString) {
        showRuleEditorStatus('请先输入目标字符串', 'error');
        return;
      }
      
      patternBuilderTarget = targetString;
      
      // Analyze the target string
      const analysis = analyzeTargetString(targetString);
      patternBuilderSegments = analysis.segments;
      patternBuilderSeparator = analysis.separator || '';
      
      // Display analyzed parts
      const partsContent = document.getElementById('analyzedPartsContent');
      let partsHtml = `<span class="analyzed-part-tag">原始: ${escapeHtml(targetString)}</span>`;
      
      if (analysis.hasPrefix) {
        partsHtml += `<span class="analyzed-part-tag prefix">前缀: ${escapeHtml(analysis.prefix)}</span>`;
      }
      if (analysis.hasSeparator) {
        partsHtml += `<span class="analyzed-part-tag separator">分隔符: "${escapeHtml(analysis.separator)}"</span>`;
      }
      partsHtml += `<span class="analyzed-part-tag">码段数: ${analysis.segments.length}</span>`;
      
      partsContent.innerHTML = partsHtml;
      
      // Pre-fill prefix
      document.getElementById('enablePrefix').checked = analysis.hasPrefix;
      document.getElementById('prefixKeywords').value = analysis.hasPrefix ? analysis.prefix : 'code|优惠码|折扣码';
      
      // Update separator display
      document.getElementById('detectedSeparator').textContent = analysis.separator || '无';
      document.getElementById('segmentCount').textContent = analysis.segments.length;
      
      // Generate segment UI
      generateSegmentUI(analysis.segments, analysis.separator);
      
      // Update pattern preview
      updatePatternPreview();
      
      // Show modal
      document.getElementById('patternBuilderModal').classList.add('visible');
    }
    
    /**
     * Generate UI for each code segment
     */
    function generateSegmentUI(segments, separator) {
      const container = document.getElementById('codeSegmentsContainer');
      let html = '';
      
      segments.forEach((segment, index) => {
        const typeClass = segment.isFixed ? 'segment-fixed-badge' : 'segment-variable-badge';
        const typeLabel = segment.isFixed ? '固定' : '变动';
        
        html += `
          <div class="code-segment" data-index="${index}">
            <div class="code-segment-header">
              <span class="segment-label">
                第 ${index + 1} 段
                <span class="segment-value">${escapeHtml(segment.value)}</span>
                <span class="${typeClass}">${typeLabel}</span>
              </span>
              <span class="segment-length-info">长度: ${segment.length} 字符</span>
            </div>
            <div class="code-segment-body">
              <select class="segment-type-select" id="segmentType_${index}" onchange="onSegmentTypeChange(${index})">
                <option value="fixed" ${segment.isFixed ? 'selected' : ''}>固定字符串 (精确匹配)</option>
                <option value="variable" ${!segment.isFixed ? 'selected' : ''}>变动字符串 (模式匹配)</option>
              </select>
              <div id="segmentOptions_${index}" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                ${segment.isFixed ? `
                  <span style="color:#666; font-size:12px;">将精确匹配: <code>${escapeHtml(segment.value)}</code></span>
                ` : `
                  <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; width:100%;">
                    <label style="display:flex; align-items:center; gap:5px; margin:0;">
                      <input type="checkbox" id="segmentHasPrefix_${index}" onchange="onSegmentPrefixToggle(${index})" style="width:auto;">
                      <span style="font-size:12px;">固定前缀:</span>
                    </label>
                    <input type="text" id="segmentPrefix_${index}" placeholder="如: VIP, NEW" style="width:80px; padding:4px; font-size:12px; display:none;" onchange="updatePatternPreview()">
                    <select id="segmentCharType_${index}" onchange="updatePatternPreview()" style="padding:4px 8px; font-size:12px;">
                      <option value="alphanumeric" ${segment.charType === 'alphanumeric' ? 'selected' : ''}>字母+数字</option>
                      <option value="letters" ${segment.charType === 'letters' ? 'selected' : ''}>仅字母</option>
                      <option value="numbers" ${segment.charType === 'numbers' ? 'selected' : ''}>仅数字</option>
                    </select>
                    <span style="font-size:12px;">长度:</span>
                    <input type="number" id="segmentMinLen_${index}" value="${Math.max(segment.length - 1, 1)}" min="1" max="50" style="width:50px; padding:4px; font-size:12px;" onchange="updatePatternPreview()">
                    <span>-</span>
                    <input type="number" id="segmentMaxLen_${index}" value="${segment.length + 2}" min="1" max="50" style="width:50px; padding:4px; font-size:12px;" onchange="updatePatternPreview()">
                  </div>
                `}
              </div>
            </div>
          </div>
        `;
        
        // Add separator indicator between segments
        if (index < segments.length - 1 && separator) {
          html += `<div class="segment-separator">${escapeHtml(separator)}</div>`;
        }
      });
      
      container.innerHTML = html;
    }
    
    /**
     * Handle segment type change
     */
    function onSegmentTypeChange(index) {
      const typeSelect = document.getElementById(`segmentType_${index}`);
      const optionsDiv = document.getElementById(`segmentOptions_${index}`);
      const segment = patternBuilderSegments[index];
      const isFixed = typeSelect.value === 'fixed';
      
      // Update segment data
      segment.isFixed = isFixed;
      segment.type = isFixed ? 'fixed' : 'variable';
      
      // Update badge
      const badge = document.querySelector(`.code-segment[data-index="${index}"] .segment-fixed-badge, .code-segment[data-index="${index}"] .segment-variable-badge`);
      if (badge) {
        badge.className = isFixed ? 'segment-fixed-badge' : 'segment-variable-badge';
        badge.textContent = isFixed ? '固定' : '变动';
      }
      
      // Update options UI
      if (isFixed) {
        optionsDiv.innerHTML = `<span style="color:#666; font-size:12px;">将精确匹配: <code>${escapeHtml(segment.value)}</code></span>`;
      } else {
        optionsDiv.innerHTML = `
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; width:100%;">
            <label style="display:flex; align-items:center; gap:5px; margin:0;">
              <input type="checkbox" id="segmentHasPrefix_${index}" onchange="onSegmentPrefixToggle(${index})" style="width:auto;">
              <span style="font-size:12px;">固定前缀:</span>
            </label>
            <input type="text" id="segmentPrefix_${index}" placeholder="如: VIP, NEW" style="width:80px; padding:4px; font-size:12px; display:none;" onchange="updatePatternPreview()">
            <select id="segmentCharType_${index}" onchange="updatePatternPreview()" style="padding:4px 8px; font-size:12px;">
              <option value="alphanumeric" ${segment.charType === 'alphanumeric' ? 'selected' : ''}>字母+数字</option>
              <option value="letters" ${segment.charType === 'letters' ? 'selected' : ''}>仅字母</option>
              <option value="numbers" ${segment.charType === 'numbers' ? 'selected' : ''}>仅数字</option>
            </select>
            <span style="font-size:12px;">长度:</span>
            <input type="number" id="segmentMinLen_${index}" value="${Math.max(segment.length - 1, 1)}" min="1" max="50" style="width:50px; padding:4px; font-size:12px;" onchange="updatePatternPreview()">
            <span>-</span>
            <input type="number" id="segmentMaxLen_${index}" value="${segment.length + 2}" min="1" max="50" style="width:50px; padding:4px; font-size:12px;" onchange="updatePatternPreview()">
          </div>
        `;
      }
      
      updatePatternPreview();
    }
    
    /**
     * Handle segment prefix toggle
     */
    function onSegmentPrefixToggle(index) {
      const checkbox = document.getElementById(`segmentHasPrefix_${index}`);
      const prefixInput = document.getElementById(`segmentPrefix_${index}`);
      
      if (checkbox.checked) {
        prefixInput.style.display = 'block';
        // Try to auto-detect prefix from segment value
        const segment = patternBuilderSegments[index];
        const match = segment.value.match(/^([A-Z]{2,4})/i);
        if (match) {
          prefixInput.value = match[1];
        }
      } else {
        prefixInput.style.display = 'none';
        prefixInput.value = '';
      }
      
      updatePatternPreview();
    }
    
    /**
     * Close the pattern builder modal
     */
    function closePatternBuilder(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('patternBuilderModal').classList.remove('visible');
    }
    
    /**
     * Add a prefix keyword to the list
     */
    function addPrefixKeyword(keyword) {
      const input = document.getElementById('prefixKeywords');
      const current = input.value.trim();
      
      if (!current) {
        input.value = keyword;
      } else {
        // Check if keyword already exists
        const keywords = current.split('|').map(k => k.trim().toLowerCase());
        if (!keywords.includes(keyword.toLowerCase())) {
          input.value = current + '|' + keyword;
        }
      }
      
      updatePatternPreview();
    }
    
    /**
     * Update the pattern preview based on current settings (new version)
     */
    function updatePatternPreview() {
      const enablePrefix = document.getElementById('enablePrefix').checked;
      
      let pattern = '';
      let displayHtml = '';
      
      // Part 1: Prefix
      if (enablePrefix) {
        const prefixKeywords = document.getElementById('prefixKeywords').value.trim();
        if (prefixKeywords) {
          const prefixPattern = `(?:${prefixKeywords})[：:\\s]*`;
          pattern += prefixPattern;
          displayHtml += `<span class="regex-prefix">(?:${escapeHtml(prefixKeywords)})[：:\\s]*</span>`;
        }
      }
      
      // Start capture group
      pattern += '(?<code>';
      displayHtml += '<span class="regex-group">(?&lt;code&gt;</span>';
      
      // Part 2: Code segments
      patternBuilderSegments.forEach((segment, index) => {
        const typeSelect = document.getElementById(`segmentType_${index}`);
        const isFixed = typeSelect ? typeSelect.value === 'fixed' : segment.isFixed;
        
        if (isFixed) {
          // Fixed segment - exact match
          const escapedValue = escapeRegexSpecialChars(segment.value);
          pattern += escapedValue;
          displayHtml += `<span class="regex-fixed">${escapeHtml(escapedValue)}</span>`;
        } else {
          // Variable segment - pattern match
          const hasPrefixCheckbox = document.getElementById(`segmentHasPrefix_${index}`);
          const prefixInput = document.getElementById(`segmentPrefix_${index}`);
          const charTypeSelect = document.getElementById(`segmentCharType_${index}`);
          const minLenInput = document.getElementById(`segmentMinLen_${index}`);
          const maxLenInput = document.getElementById(`segmentMaxLen_${index}`);
          
          // Check if segment has fixed prefix
          const hasPrefix = hasPrefixCheckbox && hasPrefixCheckbox.checked;
          const prefixValue = hasPrefix && prefixInput ? prefixInput.value.trim() : '';
          
          // Add fixed prefix if specified
          if (prefixValue) {
            const escapedPrefix = escapeRegexSpecialChars(prefixValue);
            pattern += escapedPrefix;
            displayHtml += `<span class="regex-fixed">${escapeHtml(escapedPrefix)}</span>`;
          }
          
          const charType = charTypeSelect ? charTypeSelect.value : segment.charType;
          let minLen = minLenInput ? parseInt(minLenInput.value) : Math.max(segment.length - 1, 1);
          let maxLen = maxLenInput ? parseInt(maxLenInput.value) : segment.length + 2;
          
          // Adjust length if prefix is used
          if (prefixValue) {
            const prefixLen = prefixValue.length;
            minLen = Math.max(minLen - prefixLen, 1);
            maxLen = Math.max(maxLen - prefixLen, 1);
          }
          
          let charClass = '[A-Z0-9]';
          if (charType === 'letters') charClass = '[A-Z]';
          else if (charType === 'numbers') charClass = '[0-9]';
          
          const segmentPattern = `${charClass}{${minLen},${maxLen}}`;
          pattern += segmentPattern;
          displayHtml += `<span class="regex-variable">${escapeHtml(segmentPattern)}</span>`;
        }
        
        // Add separator between segments
        if (index < patternBuilderSegments.length - 1 && patternBuilderSeparator) {
          const escapedSep = escapeRegexSpecialChars(patternBuilderSeparator);
          pattern += escapedSep;
          displayHtml += `<span class="regex-separator">${escapeHtml(escapedSep)}</span>`;
        }
      });
      
      // Close capture group
      pattern += ')';
      displayHtml += '<span class="regex-group">)</span>';
      
      // Update preview
      document.getElementById('patternPreviewBox').innerHTML = displayHtml;
      
      // Store the generated pattern for later use
      document.getElementById('patternBuilderModal').dataset.generatedPattern = pattern;
    }
    
    /**
     * Apply the built pattern to the rule editor (new version)
     */
    function applyBuiltPattern() {
      const pattern = document.getElementById('patternBuilderModal').dataset.generatedPattern;
      
      if (!pattern) {
        showRuleEditorStatus('请先配置规则', 'error');
        return;
      }
      
      // Apply to rule editor
      document.getElementById('pattern').value = pattern;
      document.getElementById('patternFlags').value = 'gi';
      
      // Set a default name based on the first fixed segment
      const patternNameInput = document.getElementById('patternName');
      let ruleName = '自定义优惠码规则';
      
      // Find first fixed segment for naming
      const firstFixedSegment = patternBuilderSegments.find((s, i) => {
        const typeSelect = document.getElementById(`segmentType_${i}`);
        return typeSelect ? typeSelect.value === 'fixed' : s.isFixed;
      });
      
      if (patternNameInput.value === 'default' || !patternNameInput.value) {
        if (firstFixedSegment) {
          ruleName = firstFixedSegment.value + ' 优惠码';
        }
        patternNameInput.value = ruleName;
      } else {
        ruleName = patternNameInput.value;
      }
      
      // Copy subject filter to rule subject pattern
      const subjectFilter = document.getElementById('subject').value.trim();
      const ruleSubjectPattern = document.getElementById('ruleSubjectPattern');
      if (subjectFilter && ruleSubjectPattern && !ruleSubjectPattern.value.trim()) {
        ruleSubjectPattern.value = subjectFilter;
      }
      
      // Display the generated pattern in the suggestions area
      const patternsList = document.getElementById('patternsList');
      const escapedPattern = pattern.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
      const escapedName = ruleName.replace(/'/g, "\\'");
      
      // Build description based on segments
      const fixedCount = patternBuilderSegments.filter((s, i) => {
        const typeSelect = document.getElementById(`segmentType_${i}`);
        return typeSelect ? typeSelect.value === 'fixed' : s.isFixed;
      }).length;
      const variableCount = patternBuilderSegments.length - fixedCount;
      let description = `智能生成: ${patternBuilderSegments.length}段码 (${fixedCount}固定 + ${variableCount}变动)`;
      if (patternBuilderSeparator) {
        description += `, 分隔符: "${patternBuilderSeparator}"`;
      }
      
      patternsList.innerHTML = `
        <div class="pattern-suggestion-item" style="border-color:#6001d2; background:#f8f4ff;" onclick="applyPatternSuggestion('${escapedPattern}', 'gi', '${escapedName}')">
          <div class="pattern-name" style="color:#6001d2;">🔧 ${escapeHtml(ruleName)}</div>
          <code class="pattern-code">${escapeHtml(pattern)}</code>
          <div class="pattern-desc">${escapeHtml(description)}</div>
          <button onclick="event.stopPropagation(); applyPatternSuggestion('${escapedPattern}', 'gi', '${escapedName}')" style="margin-top:8px; padding:5px 12px; font-size:12px; background:#6001d2;">✓ 已应用</button>
        </div>
      `;
      document.getElementById('generatedPatterns').classList.remove('hidden');
      
      // Close modal
      closePatternBuilder();
      
      // Show success message
      showRuleEditorStatus('✅ 已应用智能生成的规则', 'success');
      
      // Scroll to rule fields
      document.querySelector('#ruleEditorCard .form-group').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    /**
     * Validate regex syntax only
     * Requirements: 4.4 - IF the regex pattern is invalid THEN the System SHALL 
     * display a clear error message indicating the syntax issue
     */
    async function validateRuleSyntax() {
      const pattern = document.getElementById('pattern').value;
      const flags = document.getElementById('patternFlags').value;
      const resultEl = document.getElementById('ruleValidationResult');
      
      if (!pattern) {
        resultEl.classList.remove('hidden');
        resultEl.innerHTML = '<div class="rule-validation-error">❌ 请输入正则表达式</div>';
        return;
      }

      try {
        // First try local validation
        new RegExp(pattern, flags);
        
        // Call API for syntax validation (does not require email connection)
        const res = await apiPost('/api/regex/validate-syntax', { pattern, flags });
        const data = await res.json();
        
        resultEl.classList.remove('hidden');
        
        if (data.valid) {
          resultEl.innerHTML = `
            <div class="rule-validation-success">
              ✅ 正则表达式语法有效
              <br><small style="color:#666;">模式: <code>${escapeHtml(pattern)}</code></small>
              <br><small style="color:#666;">标志: ${flags}</small>
            </div>
          `;
          showRuleEditorStatus('✅ 语法验证通过', 'success');
        } else {
          resultEl.innerHTML = `
            <div class="rule-validation-error">
              ❌ 正则表达式无效
              <br><small>${escapeHtml(data.error || '语法错误')}</small>
            </div>
          `;
          showRuleEditorStatus('❌ 语法验证失败', 'error');
        }
      } catch (e) {
        resultEl.classList.remove('hidden');
        resultEl.innerHTML = `
          <div class="rule-validation-error">
            ❌ 正则表达式无效: ${escapeHtml(e.message)}
          </div>
        `;
        showRuleEditorStatus('❌ 语法验证失败', 'error');
      }
    }

    /**
     * Test regex against email preview content
     * Requirements: 4.3 - WHEN the user clicks "Validate Rule" THEN the System SHALL 
     * test the regex against the current email preview and display matches
     * Requirements: 4.5 - WHEN validation succeeds THEN the System SHALL highlight 
     * matched content in the email preview
     */
    async function testRuleInPreview() {
      const pattern = document.getElementById('pattern').value;
      const flags = document.getElementById('patternFlags').value;
      const resultEl = document.getElementById('ruleValidationResult');
      const previewResult = document.getElementById('previewResult');
      
      if (!pattern) {
        resultEl.classList.remove('hidden');
        resultEl.innerHTML = '<div class="rule-validation-error">❌ 请输入正则表达式</div>';
        return;
      }

      // Get preview content
      const previewText = previewResult.innerText || previewResult.textContent;
      if (!previewText) {
        resultEl.classList.remove('hidden');
        resultEl.innerHTML = '<div class="rule-validation-warning">⚠️ 请先预览邮件内容</div>';
        return;
      }

      // Extract email content from preview (skip metadata headers)
      const contentMatch = previewText.match(/===\s*内容长度:.*?\n\n([\s\S]*)/);
      const emailContent = contentMatch ? contentMatch[1] : previewText;

      try {
        // Call API to test regex
        const res = await apiPost('/api/regex/test', { 
          pattern, 
          flags, 
          content: emailContent 
        });
        const data = await res.json();
        
        resultEl.classList.remove('hidden');
        
        if (data.error) {
          resultEl.innerHTML = `
            <div class="rule-validation-error">
              ❌ 测试失败: ${escapeHtml(data.error)}
            </div>
          `;
          showRuleEditorStatus('❌ 测试失败', 'error');
          return;
        }

        const matches = data.matches || [];
        
        if (matches.length === 0) {
          resultEl.innerHTML = `
            <div class="rule-validation-warning">
              ⚠️ 没有找到匹配项
              <br><small style="color:#666;">请检查正则表达式是否正确，或尝试其他邮件</small>
            </div>
          `;
          showRuleEditorStatus('⚠️ 没有匹配', 'info');
        } else {
          // Display matches
          let matchesHtml = matches.slice(0, 10).map((m, i) => 
            `<span class="rule-match-highlight">${escapeHtml(typeof m === 'string' ? m : m.match || m.fullMatch || JSON.stringify(m))}</span>`
          ).join(' ');
          
          if (matches.length > 10) {
            matchesHtml += ` <small style="color:#666;">... 还有 ${matches.length - 10} 个匹配</small>`;
          }
          
          resultEl.innerHTML = `
            <div class="rule-validation-success">
              ✅ 找到 ${matches.length} 个匹配项
              <br><div style="margin-top:8px;">${matchesHtml}</div>
            </div>
          `;
          showRuleEditorStatus('✅ 找到 ' + matches.length + ' 个匹配', 'success');
          
          // Highlight matches in preview
          highlightMatchesInPreview(emailContent, pattern, flags);
        }
      } catch (e) {
        resultEl.classList.remove('hidden');
        resultEl.innerHTML = `
          <div class="rule-validation-error">
            ❌ 测试失败: ${escapeHtml(e.message)}
          </div>
        `;
        showRuleEditorStatus('❌ 测试失败', 'error');
      }
    }

    /**
     * Highlight regex matches in the email preview
     * Requirements: 4.5
     */
    function highlightMatchesInPreview(content, pattern, flags) {
      const previewResult = document.getElementById('previewResult');
      
      try {
        const regex = new RegExp(pattern, flags.includes('g') ? flags : flags + 'g');
        const fullPreview = previewResult.innerText || previewResult.textContent;
        
        // Find the content portion in the full preview
        const contentMatch = fullPreview.match(/===\s*内容长度:.*?\n\n([\s\S]*)/);
        const headerPart = contentMatch ? fullPreview.substring(0, contentMatch.index + contentMatch[0].length - contentMatch[1].length) : '';
        const contentPart = contentMatch ? contentMatch[1] : fullPreview;
        
        // Highlight matches in content
        let highlightedContent = contentPart;
        const matches = contentPart.match(regex);
        
        if (matches && matches.length > 0) {
          // Replace matches with highlighted version (escape HTML first, then add highlights)
          highlightedContent = escapeHtml(contentPart).replace(
            new RegExp(pattern, flags.includes('g') ? flags : flags + 'g'),
            '<span class="rule-match-highlight">$&</span>'
          );
          
          // If the simple replace didn't work, try a different approach
          if (!highlightedContent.includes('rule-match-highlight')) {
            let result = '';
            let lastIndex = 0;
            const globalRegex = new RegExp(pattern, 'g' + (flags.includes('i') ? 'i' : ''));
            let match;
            
            while ((match = globalRegex.exec(contentPart)) !== null) {
              result += escapeHtml(contentPart.substring(lastIndex, match.index));
              result += `<span class="rule-match-highlight">${escapeHtml(match[0])}</span>`;
              lastIndex = match.index + match[0].length;
            }
            result += escapeHtml(contentPart.substring(lastIndex));
            highlightedContent = result;
          }
        } else {
          highlightedContent = escapeHtml(contentPart);
        }
        
        // Reconstruct the full preview with highlighted content
        previewResult.innerHTML = escapeHtml(headerPart) + highlightedContent;
        
      } catch (e) {
        console.error('Error highlighting matches:', e);
      }
    }

    /**
     * Clear the rule editor form
     */
    function clearRuleEditor() {
      document.getElementById('targetString').value = '';
      document.getElementById('patternName').value = 'default';
      document.getElementById('ruleSubjectPattern').value = '';
      document.getElementById('pattern').value = '';
      document.getElementById('patternFlags').value = 'g';
      document.getElementById('patternTags').value = '';
      
      // Clear editing mode
      editingPatternId = null;
      updateSaveButtonState();
      
      // Hide generated patterns
      document.getElementById('generatedPatterns').classList.add('hidden');
      document.getElementById('patternsList').innerHTML = '';
      
      // Hide validation results
      document.getElementById('ruleValidationResult').classList.add('hidden');
      document.getElementById('validationResult').classList.add('hidden');
      
      // Clear status
      document.getElementById('ruleEditorStatus').textContent = '';
      
      showRuleEditorStatus('已清空规则编辑器', 'info');
    }

    /**
     * Use current rule for extraction (populate filter form)
     */
    function useCurrentRule() {
      const pattern = document.getElementById('pattern').value;
      const subjectPattern = document.getElementById('ruleSubjectPattern').value;
      const patternName = document.getElementById('patternName').value;
      const patternFlags = document.getElementById('patternFlags').value;
      const patternTags = document.getElementById('patternTags').value;
      
      if (!pattern) {
        showRuleEditorStatus('❌ 请先输入正则表达式', 'error');
        return;
      }
      
      // Populate the subject filter if we have a subject pattern
      if (subjectPattern) {
        document.getElementById('subject').value = subjectPattern;
      }
      
      // Update current rule display
      updateCurrentRuleDisplay(patternName, subjectPattern, pattern, patternFlags, patternTags);
      
      showRuleEditorStatus('✅ 规则已准备就绪，可以开始提取', 'success');
      
      // Scroll to extraction options
      document.getElementById('extractionOptionsCard').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    /**
     * Update the current rule display in extraction options
     */
    function updateCurrentRuleDisplay(name, subject, regex, flags, tags) {
      const display = document.getElementById('currentRuleDisplay');
      document.getElementById('currentRuleName').textContent = name && name !== 'default' ? name : '未命名规则';
      document.getElementById('currentRuleSubject').textContent = subject || '(无主题筛选)';
      document.getElementById('currentRuleRegex').textContent = regex;
      document.getElementById('currentRuleFlags').textContent = flags || 'g';
      
      // Display tags
      const tagsEl = document.getElementById('currentRuleTags');
      if (tags) {
        const tagList = tags.split(',').map(t => t.trim()).filter(t => t.length > 0);
        if (tagList.length > 0) {
          tagsEl.innerHTML = tagList.map(t => `<span style="background:#e3f2fd; color:#1565c0; padding:2px 6px; border-radius:10px; font-size:10px; margin-left:4px;">${escapeHtml(t)}</span>`).join('');
        } else {
          tagsEl.innerHTML = '';
        }
      } else {
        tagsEl.innerHTML = '';
      }
      
      display.classList.remove('hidden');
      
      // Enable extract button
      enableExtractButton();
    }

    /**
     * Clear the current rule display and disable extract button
     */
    function clearCurrentRule() {
      document.getElementById('currentRuleDisplay').classList.add('hidden');
      
      // Clear the pattern field as well since rule is cleared
      document.getElementById('pattern').value = '';
      document.getElementById('ruleSubjectPattern').value = '';
      document.getElementById('subject').value = '';
      
      // Disable extract button
      disableExtractButton();
    }

    /**
     * Enable the extract button
     */
    function enableExtractButton() {
      const btn = document.getElementById('extractBtn');
      const hint = document.getElementById('extractBtnHint');
      btn.disabled = false;
      btn.style.opacity = '1';
      btn.style.cursor = 'pointer';
      hint.style.display = 'none';
    }

    /**
     * Disable the extract button
     */
    function disableExtractButton() {
      const btn = document.getElementById('extractBtn');
      const hint = document.getElementById('extractBtnHint');
      btn.disabled = true;
      btn.style.opacity = '0.5';
      btn.style.cursor = 'not-allowed';
      hint.style.display = 'inline';
    }

    async function validateRegex() {
      const pattern = document.getElementById('pattern').value;
      if (!pattern) {
        alert('请输入或生成正则表达式');
        return;
      }

      try {
        new RegExp(pattern, document.getElementById('patternFlags').value);
      } catch (e) {
        alert('❌ 正则表达式无效: ' + e.message);
        return;
      }

      const validationResult = document.getElementById('validationResult');
      validationResult.classList.remove('hidden');
      validationResult.innerHTML = '<p style="color:#666;">正在验证... (最多等待 60 秒)</p>';

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 65000);
        
        const res = await apiRequest('/api/regex/validate', {
          method: 'POST',
          body: JSON.stringify({
            sessionId,
            filter: getFilter(),
            pattern: {
              name: document.getElementById('patternName').value,
              pattern: pattern,
              flags: document.getElementById('patternFlags').value
            },
            stripHtml: document.getElementById('stripHtml').checked,
            count: 3
          }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!res.ok) {
          const error = await res.json();
          validationResult.innerHTML = `<p style="color:#dc3545;">❌ 验证失败: ${error.error || 'Unknown error'}</p>`;
          return;
        }

        const data = await res.json();

        if (data.error) {
          validationResult.innerHTML = `<p style="color:#dc3545;">❌ 验证失败: ${data.error}</p>`;
          return;
        }

        let html = `
          <div style="margin-bottom:10px; padding:10px; background:#e8f5e9; border-radius:3px;">
            <strong style="color:#2e7d32;">✅ 验证结果</strong>
            <br>测试邮件: ${data.summary.tested} 封
            <br>成功提取: ${data.summary.successful} 封 (${data.summary.successRate}%)
            <br>总匹配数: ${data.summary.totalMatches}
            ${data.summary.timedOut ? '<br><small style="color:#ff9800;">⚠️ 验证在 60 秒后停止</small>' : ''}
          </div>
        `;

        data.results.forEach((r, idx) => {
          if (r.error) {
            html += `<div style="padding:8px; margin:5px 0; background:#ffebee; border-radius:3px; border-left:3px solid #dc3545;">
              <strong style="color:#dc3545;">❌ 邮件 ${idx + 1}: 错误</strong>
              <br><small>${escapeHtml(r.error)}</small>
            </div>`;
          } else {
            const status = r.matchCount > 0 ? '✅' : '❌';
            html += `<div style="padding:8px; margin:5px 0; background:${r.matchCount > 0 ? '#e8f5e9' : '#fff3e0'}; border-radius:3px; border-left:3px solid ${r.matchCount > 0 ? '#4caf50' : '#ff9800'};">
              <strong>${status} 邮件 ${idx + 1}: ${escapeHtml(r.subject)}</strong>
              <br><small style="color:#666;">发件人: ${escapeHtml(r.from)}</small>
              <br><small style="color:#666;">匹配数: ${r.matchCount}</small>
              ${r.matches && r.matches.length > 0 ? `<br><small style="color:#2e7d32;"><strong>提取内容:</strong> ${r.matches.map(m => escapeHtml(m.fullMatch)).join(', ')}</small>` : ''}
            </div>`;
          }
        });

        if (data.summary.successRate === 100) {
          html += `<div style="padding:10px; margin-top:10px; background:#d4edda; border-radius:3px; border:1px solid #c3e6cb;">
            <strong style="color:#155724;">✅ 验证通过！规则可以正确提取内容</strong>
          </div>`;
        } else if (data.summary.successRate >= 50) {
          html += `<div style="padding:10px; margin-top:10px; background:#fff3cd; border-radius:3px; border:1px solid #ffeaa7;">
            <strong style="color:#856404;">⚠️ 部分成功，建议调整规则</strong>
          </div>`;
        } else {
          html += `<div style="padding:10px; margin-top:10px; background:#f8d7da; border-radius:3px; border:1px solid #f5c6cb;">
            <strong style="color:#721c24;">❌ 验证失败，请调整规则</strong>
          </div>`;
        }

        validationResult.innerHTML = html;
      } catch (e) {
        if (e.name === 'AbortError') {
          validationResult.innerHTML = `<p style="color:#dc3545;">❌ 验证超时 (60 秒)，请检查网络连接或减少邮件数量</p>`;
        } else {
          validationResult.innerHTML = `<p style="color:#dc3545;">❌ 验证出错: ${e.message}</p>`;
        }
      }
    }
  </script>
</body>
</html>
